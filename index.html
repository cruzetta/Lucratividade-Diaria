<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Fechamento de Caixa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.379.0/dist/umd/lucide.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        #app-container.loading {
            display: none;
        }
        #loading-screen {
            display: flex;
        }
        section.page { display: none; }
        section.page.active { display: block; }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .btn-save-feedback { transition: all 0.3s ease; }
        .drop-zone {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone.drag-over {
            background-color: #e0e7ff;
            border-color: #6366f1;
        }
        details[open] summary .chevron-summary {
            transform: rotate(180deg);
        }
        .step-container.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-link.active {
            background-color: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Estilo para notificações (Toast) */
        #notification-container {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
        }
        .toast {
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast.info { background-color: #3b82f6; }
        .toast.success { background-color: #22c55e; }
        .toast.error { background-color: #ef4444; }
        .toast.warning { background-color: #f59e0b; }
        
        /* Estilos do Modal de Revisão */
        .tab-button {
            padding: 0.5rem 1rem;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .detail-row:last-child {
            border-bottom: none;
        }
        .detail-label {
            display: flex;
            flex-direction: column;
        }
         .detail-label .main-label {
            font-weight: 500;
            color: #4b5563;
        }
        .detail-label .calc-label {
            font-size: 0.75rem; /* 12px */
            color: #6b7280;
            font-style: italic;
        }
        .detail-value {
            font-weight: 600;
            text-align: right;
        }

    </style>
</head>
<body class="bg-slate-100 text-slate-800">
    <div id="loading-screen" class="fixed inset-0 bg-slate-100 flex flex-col items-center justify-center z-[100]">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-indigo-600"></div>
        <p id="loading-message" class="mt-4 text-lg font-semibold text-slate-700">Conectando à nuvem...</p>
    </div>

    <div id="app-container" class="loading">
        <header class="bg-white/80 backdrop-blur-lg shadow-md sticky top-0 z-50">
            <nav class="container mx-auto px-4 md:px-8 flex justify-between items-center h-16">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <a href="#fechamento" data-page="page-fechamento" class="nav-link text-slate-600 hover:text-indigo-600 font-semibold text-sm sm:text-base">Fechamento do Dia</a>
                    <a href="#relatorio" data-page="page-relatorio" class="nav-link text-slate-600 hover:text-indigo-600 font-semibold text-sm sm:text-base">Relatório Detalhado</a>
                    <a href="#historico" data-page="page-historico" class="nav-link text-slate-600 hover:text-indigo-600 font-semibold text-sm sm:text-base">Histórico</a>
                    <a href="#cardapio" data-page="page-cardapio" class="nav-link text-slate-600 hover:text-indigo-600 font-semibold text-sm sm:text-base">Cardápio</a>
                </div>
                 <button id="reset-day-btn" class="hidden sm:inline-flex items-center bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 transition-all transform hover:scale-105">
                    <i data-lucide="refresh-cw" class="h-5 w-5 mr-2"></i>
                    Reiniciar Fechamento
                </button>
            </nav>
        </header>

        <main class="container mx-auto p-4 md:p-8 max-w-7xl">

            <!-- PÁGINA DE FECHAMENTO -->
            <section id="page-fechamento" class="page">
                <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Fechamento do Dia (<span id="current-date-display"></span>)</h1>
                    <p class="mt-2 text-md md:text-lg text-slate-600">Siga os passos para um fechamento de caixa rápido e preciso.</p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Coluna Principal: Ações do Dia -->
                    <div class="lg:col-span-2 space-y-8">
                        <div class="card">
                            <h2 class="text-2xl font-bold mb-4 text-slate-800 flex items-center">
                                <i data-lucide="calculator" class="h-8 w-8 mr-3 text-indigo-600"></i>
                                Área de Fechamento Diário
                            </h2>
                            
                            <!-- PASSO 1 -->
                            <div id="step-1-container" class="step-container pt-4 border-t">
                                <h3 class="text-xl font-semibold text-slate-700 mb-3 flex items-center">
                                    <span class="bg-indigo-600 text-white rounded-full h-8 w-8 text-lg font-bold flex items-center justify-center mr-3">1</span>
                                    Importar Relatórios & Vendas Manuais
                                </h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <p class="text-sm font-medium text-slate-600 mb-2">Relatório de Pedidos</p>
                                        <label for="relatorioPedidosInput" id="dropZonePedidos" class="drop-zone flex justify-center w-full px-4 py-5 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-400">
                                            <div class="text-center"><i data-lucide="file-up" class="mx-auto h-10 w-10 text-gray-400"></i><p class="mt-1 text-sm text-gray-600">Arraste ou clique</p></div>
                                        </label>
                                        <input type="file" id="relatorioPedidosInput" accept=".csv, .xlsx" class="hidden"/>
                                        <div id="fileNamePedidos" class="mt-2 text-xs text-center text-slate-500 font-medium">Nenhum arquivo.</div>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-slate-600 mb-2">Relatório de Itens</p>
                                        <label for="relatorioItensInput" id="dropZoneItens" class="drop-zone flex justify-center w-full px-4 py-5 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-400">
                                            <div class="text-center"><i data-lucide="file-up" class="mx-auto h-10 w-10 text-gray-400"></i><p class="mt-1 text-sm text-gray-600">Arraste ou clique</p></div>
                                        </label>
                                        <input type="file" id="relatorioItensInput" accept=".csv, .xlsx" class="hidden"/>
                                        <div id="fileNameItens" class="mt-2 text-xs text-center text-slate-500 font-medium">Nenhum arquivo.</div>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-slate-600 mb-2">Relatório de Adicionais</p>
                                        <label for="relatorioAdicionaisInput" id="dropZoneAdicionais" class="drop-zone flex justify-center w-full px-4 py-5 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-400">
                                            <div class="text-center"><i data-lucide="file-up" class="mx-auto h-10 w-10 text-gray-400"></i><p class="mt-1 text-sm text-gray-600">Arraste ou clique</p></div>
                                        </label>
                                        <input type="file" id="relatorioAdicionaisInput" accept=".csv, .xlsx" class="hidden"/>
                                        <div id="fileNameAdicionais" class="mt-2 text-xs text-center text-slate-500 font-medium">Nenhum arquivo.</div>
                                    </div>
                                </div>
    
                                <div class="card bg-slate-50 p-4 mt-6">
                                    <h4 class="text-md font-semibold text-slate-800 flex items-center mb-2"><i data-lucide="hand-coins" class="h-4 w-4 mr-2"></i>Adicionar Item Vendido Manualmente</h4>
                                    <div class="grid grid-cols-12 gap-2 items-end">
                                        <div class="col-span-8">
                                            <label class="text-xs font-medium">Nome do Item</label>
                                            <input type="text" id="manual-item-name" list="cardapio-datalist" placeholder="Digite para buscar..." class="w-full p-2 mt-1 border rounded-md text-sm">
                                            <datalist id="cardapio-datalist"></datalist>
                                        </div>
                                        <div class="col-span-4"><label class="text-xs font-medium">Quantidade</label><input type="number" id="manual-item-quantity" placeholder="1" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                    </div>
                                    <button id="add-manual-item-btn" class="w-full mt-3 bg-blue-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-blue-600 text-sm">Adicionar Item</button>
                                    <div class="mt-3">
                                        <h5 class="font-medium text-slate-800 text-sm">Itens Manuais Adicionados:</h5>
                                        <ul id="manual-items-list" class="mt-1 text-xs text-slate-600 list-disc list-inside max-h-20 overflow-y-auto p-2">
                                            <li class="italic list-none">Nenhum item manual.</li>
                                        </ul>
                                    </div>
                               </div>
    
                                 <div class="mt-6 text-right">
                                    <button id="review-files-btn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700 flex items-center justify-center ml-auto">
                                        Revisar Arquivos Importados <i data-lucide="arrow-right" class="h-5 w-5 ml-2"></i>
                                    </button>
                                </div>
                            </div>
    
                            <!-- ALERTA DE ITENS PENDENTES -->
                            <div id="cadastro-pendente-card" class="card border-l-4 border-yellow-400 hidden mt-6">
                                <h2 class="text-2xl font-bold mb-2 text-yellow-600 flex items-center"><i data-lucide="alert-triangle" class="h-8 w-8 mr-3"></i> Ação Necessária: Itens Novos</h2>
                                <p class="text-slate-600 mb-4">Encontramos itens que não estão no cardápio. Cadastre-os ou ignore-os para continuar.</p>
                                <div id="cadastro-pendente-list" class="mt-4 space-y-6"></div>
                            </div>
    
                            <!-- PASSO 2 -->
                             <div id="step-2-container" class="step-container disabled pt-6 border-t mt-6">
                                <h3 class="text-xl font-semibold text-slate-700 mb-3 flex items-center">
                                    <span class="bg-indigo-600 text-white rounded-full h-8 w-8 text-lg font-bold flex items-center justify-center mr-3">2</span> Informar Dados Manuais
                                </h3>
                                <div>
                                    <label for="taxaServicoInput" class="block text-sm font-medium text-slate-700">Valor Total da Taxa de Serviço (R$)</label>
                                    <input type="number" id="taxaServicoInput" placeholder="0.00" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                                </div>
                                
                                <div class="card bg-slate-50 p-4 mt-6">
                                    <h4 class="text-md font-semibold text-slate-800 flex items-center mb-2"><i data-lucide="users" class="h-4 w-4 mr-2"></i>Custo com Diaristas</h4>
                                    <div class="grid grid-cols-2 gap-2">
                                        <div><label class="text-xs font-medium">Nº</label><input type="number" id="daily-staff-count" placeholder="0" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                        <div><label class="text-xs font-medium">Custo/Pessoa</label><input type="number" id="daily-staff-cost" placeholder="100" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                    </div>
                                </div>
    
                                <div class="card bg-slate-50 p-4 mt-6">
                                    <h4 class="text-md font-semibold text-slate-800 flex items-center mb-2"><i data-lucide="plus-circle" class="h-4 w-4 mr-2"></i>Despesas Extras do Dia</h4>
                                    <div class="grid grid-cols-12 gap-2 items-end">
                                        <div class="col-span-7"><label class="text-xs font-medium">Descrição</label><input type="text" id="extra-expense-desc" placeholder="Ex: Gelo" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                        <div class="col-span-5"><label class="text-xs font-medium">Valor (R$)</label><input type="number" id="extra-expense-value" placeholder="20.00" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                    </div>
                                   <button id="add-extra-expense-btn" class="w-full mt-3 bg-red-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-red-600 text-sm">Adicionar Despesa</button>
                                    <div class="mt-3">
                                        <h5 class="font-medium text-slate-800 text-sm">Lançadas:</h5>
                                        <ul id="extra-expenses-list" class="mt-1 text-xs text-slate-600 list-disc list-inside max-h-20 overflow-y-auto p-2">
                                            <li class="italic list-none">Nenhuma despesa extra.</li>
                                        </ul>
                                    </div>
                                </div>
                                  <div class="mt-6 text-right">
                                    <button id="finalizarFechamentoBtn" class="bg-green-600 text-white font-bold text-lg py-3 px-8 rounded-lg hover:bg-green-700 transition shadow-lg flex items-center justify-center ml-auto">
                                        <i data-lucide="check-circle" class="h-6 w-6 mr-3"></i> Confirmar Itens de Viagem e Calcular
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
    
                    <!-- Coluna Lateral: Resumo e Configs -->
                    <div class="space-y-8">
                        <div class="card sticky top-20">
                            <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="bar-chart-2" class="h-5 w-5 mr-3 text-indigo-600"></i>Resumo do Dia</h2>
                            <div id="summary-content" class="space-y-3">
                                <div class="text-center p-4 bg-gray-50 rounded-lg"><p class="text-slate-600">Aguardando dados...</p></div>
                            </div>
                        </div>
                        <div class="card">
                            <details>
                                <summary class="cursor-pointer text-xl font-semibold text-slate-900 flex items-center justify-between">
                                    <span><i data-lucide="settings-2" class="h-5 w-5 mr-3 inline-block text-indigo-600"></i>Configurações</span>
                                    <i data-lucide="chevron-down" class="chevron-summary h-5 w-5 transition-transform"></i>
                                </summary>
                                <div class="mt-4 pt-4 border-t space-y-4">
                                    <div><label class="block text-sm font-medium">Despesas Fixas Mensais (R$)</label><input type="number" id="config-monthly-expenses" class="mt-1 block w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Dias Úteis no Mês</label><input type="number" id="config-working-days" class="mt-1 block w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Imposto Sobre Faturamento (%)</label><input type="number" id="config-imposto-faturamento" class="mt-1 block w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Taxa iFood (%)</label><input type="number" id="config-taxa-ifood-percentual" class="mt-1 block w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Taxa Fixa iFood (R$)</label><input type="number" id="config-taxa-ifood-fixa" class="mt-1 block w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Taxa Cartão (Canais Próprios, %)</label><input type="number" id="config-taxa-cartao" class="mt-1 block w-full p-2 border rounded-md"></div>
                                    <div><label class="block text-sm font-medium">Custo Adicional por Item para Viagem (R$)</label><input type="number" id="config-custo-adicional-delivery" class="mt-1 block w-full p-2 border rounded-md"></div>
                                    <div class="text-right mt-6"><button id="save-config-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center ml-auto btn-save-feedback"><i data-lucide="save" class="h-5 w-5 mr-2"></i><span class="btn-text">Salvar</span></button></div>
                                </div>
                            </details>
                        </div>
                    </div>
                </div>
            </section>
    
            <!-- PÁGINA DE RELATÓRIO DETALHADO -->
            <section id="page-relatorio" class="page">
                 <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Relatório Detalhado do Dia</h1>
                    <div class="mt-4 flex justify-center gap-4">
                        <button id="export-excel-btn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700 flex items-center">
                            <i data-lucide="file-spreadsheet" class="h-5 w-5 mr-2"></i> Exportar para Excel
                        </button>
                        <button id="archive-day-btn" class="bg-purple-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-purple-700 flex items-center">
                            <i data-lucide="archive" class="h-5 w-5 mr-2"></i> Concluir e Arquivar Dia
                        </button>
                    </div>
                </header>
                <div id="detailed-report-content" class="space-y-8">
                    <div class="text-center p-6 bg-white rounded-lg shadow"><p class="text-slate-600">Calcule o resultado final na aba "Fechamento do Dia" para gerar o relatório.</p></div>
                </div>
            </section>
    
            <!-- PÁGINA DO HISTÓRICO -->
            <section id="page-historico" class="page">
                 <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Histórico de Fechamentos</h1>
                    <p class="mt-2 text-md md:text-lg text-slate-600">Consulte os relatórios detalhados de dias anteriores.</p>
                </header>
                <div id="history-content" class="space-y-4">
                    <div class="text-center p-6 bg-white rounded-lg shadow"><p class="text-slate-600">Nenhum dia arquivado ainda.</p></div>
                </div>
            </section>
    
            <!-- PÁGINA DO CARDÁPIO -->
            <section id="page-cardapio" class="page">
                 <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Gerenciamento do Cardápio</h1>
                    <p class="mt-2 text-md md:text-lg text-slate-600">Adicione, edite e organize todos os seus produtos e preços.</p>
                </header>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Produtos Carregados</h2>
                         <div id="cardapio-list-container" class="mt-2 text-sm text-slate-600 max-h-[70vh] overflow-y-auto p-2 space-y-2"></div>
                    </div>
                    <div class="space-y-8">
                        <div class="card">
                            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Adicionar Novo Produto</h2>
                             <div class="space-y-4">
                                <div><label class="text-sm font-medium">Nome do Produto <span class="text-xs text-gray-500">(use "!" no final para iFood)</span></label><input type="text" id="manual-product-name" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div><label class="text-sm font-medium">Custo de Produção (R$)</label><input type="number" id="manual-product-cost" class="w-full p-2 mt-1 border rounded-md"></div>
                                 <div><label class="text-sm font-medium">Preço de Venda (R$)</label><input type="number" id="manual-product-price" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="pt-2"><label class="flex items-center gap-2 text-sm font-medium"><input type="checkbox" id="manual-product-is-bebida" class="h-4 w-4 rounded">É uma bebida?</label></div>
                            </div>
                            <button id="manual-add-product-btn" class="w-full mt-4 bg-green-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-600">Salvar Produto</button>
                        </div>
                         <div class="card">
                            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Gerenciar Cardápio</h2>
                            <div class="flex flex-col gap-3 mt-4">
                                <button id="export-cardapio-csv-btn" class="w-full bg-blue-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-blue-600 flex items-center justify-center">
                                    <i data-lucide="download" class="h-5 w-5 mr-2"></i> Exportar para CSV
                                </button>
                                <label for="daily-menu-csv-input" id="dropZoneCardapio" class="drop-zone flex justify-center w-full px-4 py-5 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-400">
                                    <div class="text-center">
                                        <i data-lucide="upload-cloud" class="mx-auto h-10 w-10 text-gray-400"></i>
                                        <p class="mt-1 text-sm text-gray-600">Importar em Massa (CSV)</p>
                                        <p class="text-xs text-gray-500">Arraste ou clique para substituir</p>
                                    </div>
                                </label>
                            </div>
                            <input type="file" id="daily-menu-csv-input" class="hidden" accept=".csv, .xlsx">
                            <div id="fileNameCardapio" class="mt-2 text-xs text-center text-slate-600 font-medium"></div>
                             <button id="prepare-import-btn" class="w-full mt-4 bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 hidden">Revisar e Preparar Importação</button>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal de Revisão de Importação do Cardápio -->
    <div id="import-review-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-2xl font-bold text-slate-800">Revisão da Importação de Cardápio</h3>
                    <button id="close-modal-btn" class="cursor-pointer z-50 p-2 -mr-2">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-slate-600 mb-4">Ajuste os valores detectados no arquivo CSV conforme necessário antes de salvar o novo cardápio. Linhas com nome em branco serão ignoradas.</p>
                    <div id="import-review-table-container" class="w-full max-h-[60vh] overflow-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="p-2 w-3/6">Nome do Produto</th>
                                    <th class="p-2">Custo Prod.</th>
                                    <th class="p-2">Preço Venda</th>
                                    <th class="p-2 text-center">É Bebida?</th>
                                </tr>
                            </thead>
                            <tbody id="import-review-table-body">
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                        <button id="cancel-import-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancelar</button>
                        <button id="save-imported-cardapio-btn" class="w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">Salvar Cardápio Importado</button>
                   </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Revisão dos Relatórios do Dia -->
    <div id="report-review-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-6xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-2xl font-bold text-slate-800">Revisão dos Relatórios do Dia</h3>
                    <button id="close-report-review-modal-btn" class="cursor-pointer z-50 p-2 -mr-2"><i data-lucide="x" class="h-6 w-6"></i></button>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-slate-600 mb-4">Confirme e edite os dados lidos dos seus relatórios. Linhas em branco ou com dados inválidos podem ser apagadas clicando no ícone da lixeira.</p>
                    <div class="border-b border-gray-200">
                        <nav id="report-review-tabs" class="-mb-px flex space-x-6" aria-label="Tabs"></nav>
                    </div>
                    <div id="report-review-tab-content" class="mt-4"></div>
                     <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                        <button id="cancel-report-review-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancelar</button>
                        <button id="save-reviewed-data-btn" class="w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-green-700">Salvar e Continuar</button>
                   </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Itens de Viagem -->
    <div id="takeaway-items-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-2xl font-bold text-slate-800">Confirmar Itens para Viagem (Anota Aí)</h3>
                    <button id="close-takeaway-modal-btn" class="cursor-pointer z-50 p-2 -mr-2">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-slate-600 mb-4">
                        Informe o <strong class="font-bold">número total</strong> de itens (não-bebidas) do <strong class="font-bold">Anota Aí</strong> que foram para viagem ou retirada.
                        <br>
                        <span class="text-xs italic">(O custo das embalagens do iFood já foi calculado automaticamente).</span>
                    </p>
                    <div class="w-full space-y-3">
                        <div>
                             <label for="total-takeaway-items-input" class="block text-sm font-medium text-slate-700">Total de Itens para Viagem (Anota Aí):</label>
                             <input type="number" id="total-takeaway-items-input" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2 text-lg" placeholder="0" min="0">
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                        <button id="confirm-takeaway-btn" class="w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-green-700">Confirmar e Calcular</button>
                   </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Container para Notificações -->
    <div id="notification-container"></div>

    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const getDefaultData = () => ({
            config: {
                monthlyExpenses: 2000, 
                workingDays: 26,
                impostoFaturamento: 6.0,
                taxaIfoodPercentual: 15.2,
                taxaIfoodFixa: 0.99, 
                taxaCartao: 3.5, 
                custoAdicionalDelivery: 2.00
            },
            cardapio: [],
            history: {},
        });

        // --- INICIALIZAÇÃO E CONTROLE DE ESTADO ---
        async function initializeAppSequence() {
            lucide.createIcons();

            const appContainer = document.getElementById('app-container');
            const loadingScreen = document.getElementById('loading-screen');
            const loadingMessage = document.getElementById('loading-message');
            
            const firebaseConfig = {
                apiKey: "AIzaSyAtLP2BCDSPdX-RXA-uU1cOi-i_-VpwUZU",
                authDomain: "lucratividade-diaria.firebaseapp.com",
                projectId: "lucratividade-diaria",
                storageBucket: "lucratividade-diaria.appspot.com",
                messagingSenderId: "76542676593",
                appId: "1:76542676593:web:c46f2e8aac0c6ff73e15d0",
                measurementId: "G-J3BDMTWWC9"
            };

            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        const userId = user.uid;
                        const appDocRef = doc(db, 'businessData', userId); 

                        try {
                            const docSnap = await getDoc(appDocRef);
                            const defaults = getDefaultData();
                            if (docSnap.exists()) {
                                const remoteData = docSnap.data();
                                window.appData = {
                                    config: { ...defaults.config, ...(remoteData.config || {}) },
                                    cardapio: Array.isArray(remoteData.cardapio) ? remoteData.cardapio.map(p => ({...p, isEditing: false})) : [],
                                    history: remoteData.history || {},
                                };
                            } else {
                                console.log("Nenhum dado encontrado, criando documento inicial.");
                                window.appData = defaults;
                                await setDoc(appDocRef, window.appData);
                            }
                            
                            window.db = db;
                            window.appDocRef = appDocRef;
                            
                            loadingScreen.style.display = 'none';
                            appContainer.classList.remove('loading');
                            
                            main(); 
                        } catch (error) {
                             console.error("Erro no listener do Firebase: ", error);
                            loadingMessage.textContent = "Erro de permissão. Verifique as regras do Firestore.";
                            loadingMessage.classList.add('text-red-600');
                        }

                    } else {
                         await signInAnonymously(auth);
                    }
                });

            } catch (error) {
                console.error("Falha na sequência de inicialização:", error);
                loadingMessage.textContent = "Falha ao conectar. Verifique a configuração e recarregue.";
                loadingMessage.classList.add('text-red-600');
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeAppSequence);
        
        // --- FUNÇÃO PRINCIPAL DO APP ---
        function main() {
            // --- ELEMENTOS DA UI ---
            const ui = {
                pages: document.querySelectorAll('.page'),
                navLinks: document.querySelectorAll('.nav-link'),
                resetDayBtn: document.getElementById('reset-day-btn'),
                saveConfigBtn: document.getElementById('save-config-btn'),
                configInputs: {
                    monthlyExpenses: document.getElementById('config-monthly-expenses'),
                    workingDays: document.getElementById('config-working-days'),
                    impostoFaturamento: document.getElementById('config-imposto-faturamento'),
                    taxaIfoodPercentual: document.getElementById('config-taxa-ifood-percentual'),
                    taxaIfoodFixa: document.getElementById('config-taxa-ifood-fixa'),
                    taxaCartao: document.getElementById('config-taxa-cartao'),
                    custoAdicionalDelivery: document.getElementById('config-custo-adicional-delivery'),
                },
                productForm: {
                    name: document.getElementById('manual-product-name'),
                    cost: document.getElementById('manual-product-cost'),
                    price: document.getElementById('manual-product-price'),
                    isBebida: document.getElementById('manual-product-is-bebida'),
                    addBtn: document.getElementById('manual-add-product-btn'),
                },
                cardapioListContainer: document.getElementById('cardapio-list-container'),
                cardapioDatalist: document.getElementById('cardapio-datalist'),
                exportCardapioCsvBtn: document.getElementById('export-cardapio-csv-btn'),
                menuCsv: {
                    input: document.getElementById('daily-menu-csv-input'),
                    dropZone: document.getElementById('dropZoneCardapio'),
                    fileName: document.getElementById('fileNameCardapio'),
                    prepareBtn: document.getElementById('prepare-import-btn'),
                },
                importModal: {
                    container: document.getElementById('import-review-modal'),
                    tableBody: document.getElementById('import-review-table-body'),
                    saveBtn: document.getElementById('save-imported-cardapio-btn'),
                    closeBtn: document.getElementById('close-modal-btn'),
                    cancelBtn: document.getElementById('cancel-import-btn'),
                },
                reportReviewModal: {
                    container: document.getElementById('report-review-modal'),
                    tabs: document.getElementById('report-review-tabs'),
                    tabContent: document.getElementById('report-review-tab-content'),
                    saveBtn: document.getElementById('save-reviewed-data-btn'),
                    closeBtn: document.getElementById('close-report-review-modal-btn'),
                    cancelBtn: document.getElementById('cancel-report-review-btn'),
                },
                takeawayModal: {
                    container: document.getElementById('takeaway-items-modal'),
                    list: document.getElementById('takeaway-items-list'),
                    confirmBtn: document.getElementById('confirm-takeaway-btn'),
                    closeBtn: document.getElementById('close-takeaway-modal-btn'),
                },
                fechamento: {
                    step1: document.getElementById('step-1-container'),
                    step2: document.getElementById('step-2-container'),
                    pedidos: {
                        input: document.getElementById('relatorioPedidosInput'),
                        dropZone: document.getElementById('dropZonePedidos'),
                        fileName: document.getElementById('fileNamePedidos'),
                    },
                    itens: {
                        input: document.getElementById('relatorioItensInput'),
                        dropZone: document.getElementById('dropZoneItens'),
                        fileName: document.getElementById('fileNameItens'),
                    },
                    adicionais: {
                        input: document.getElementById('relatorioAdicionaisInput'),
                        dropZone: document.getElementById('dropZoneAdicionais'),
                        fileName: document.getElementById('fileNameAdicionais'),
                    },
                    manualItem: {
                        nameInput: document.getElementById('manual-item-name'),
                        quantityInput: document.getElementById('manual-item-quantity'),
                        addBtn: document.getElementById('add-manual-item-btn'),
                        listUl: document.getElementById('manual-items-list'),
                    },
                    reviewFilesBtn: document.getElementById('review-files-btn'),
                    finalizarBtn: document.getElementById('finalizarFechamentoBtn'),
                    taxaServicoInput: document.getElementById('taxaServicoInput'),
                    staffCountInput: document.getElementById('daily-staff-count'),
                    staffCostInput: document.getElementById('daily-staff-cost'),
                    extraExpense: {
                        desc: document.getElementById('extra-expense-desc'),
                        value: document.getElementById('extra-expense-value'),
                        addBtn: document.getElementById('add-extra-expense-btn'),
                        listUl: document.getElementById('extra-expenses-list'),
                    },
                    summaryContainer: document.getElementById('summary-content'),
                    cadastroPendente: {
                        card: document.getElementById('cadastro-pendente-card'),
                        list: document.getElementById('cadastro-pendente-list'),
                    }
                },
                detailedReportContent: document.getElementById('detailed-report-content'),
                historyContent: document.getElementById('history-content'),
                archiveDayBtn: document.getElementById('archive-day-btn'),
                exportExcelBtn: document.getElementById('export-excel-btn'),
                currentDateDisplay: document.getElementById('current-date-display'),
                notificationContainer: document.getElementById('notification-container'),
            };

            // --- ESTADO E CONSTANTES ---
            let sessionData = {
                pedidoFile: null,
                itensFile: null,
                adicionaisFile: null,
                menuFile: null,
                manualItems: [],
                extraExpenses: [],
                ignoredItems: [],
                reviewedData: { pedidos: [], itens: [], adicionais: [] },
                lastFullReport: null,
            };
            
            // --- FUNÇÕES UTILITÁRIAS ---
            const formatCurrency = (value) => !isNaN(parseFloat(value)) ? parseFloat(value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const parseValue = (value) => parseFloat(String(value).replace(',', '.')) || 0;
            
            const normalizeString = (str) => {
                if (typeof str !== 'string') return '';
                return str
                    .toLowerCase()
                    .normalize("NFD")
                    .replace(/[\u0300-\u036f]/g, "");
            };

            const showNotification = (message, type = 'info', duration = 3000) => {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.textContent = message;
                ui.notificationContainer.appendChild(toast);
                setTimeout(() => toast.classList.add('show'), 10);
                setTimeout(() => {
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                }, duration);
            };

            // --- NAVEGAÇÃO ---
            function showPage(pageId) {
                ui.pages.forEach(p => p.classList.toggle('active', p.id === pageId));
                ui.navLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.page === pageId);
                    if(link.dataset.page === 'page-relatorio' && sessionData.lastFullReport) {
                       renderDetailedReport(sessionData.lastFullReport, ui.detailedReportContent);
                    } else if (link.dataset.page === 'page-historico') {
                        renderHistory();
                    }
                });
                ui.resetDayBtn.style.display = (pageId === 'page-fechamento' || pageId === 'page-relatorio') ? 'inline-flex' : 'none';
                window.location.hash = pageId.replace('page-','');
            }

            // --- GERENCIAMENTO DE DADOS (Firebase) ---
            async function saveData() {
                if (!window.appDocRef) return;
                try {
                    await setDoc(window.appDocRef, window.appData);
                } catch (e) {
                    console.error("Erro ao salvar dados no Firebase:", e);
                    showNotification("Erro ao salvar dados na nuvem.", 'error');
                }
            }
            
            // --- RENDERIZAÇÃO E ATUALIZAÇÃO DA UI ---
            function updateUIFromData() {
                Object.keys(ui.configInputs).forEach(key => {
                    if (ui.configInputs[key]) {
                        ui.configInputs[key].value = window.appData.config[key] || '';
                    }
                });
                renderCardapioList();
                populateCardapioDatalist();
            }

            function populateCardapioDatalist() {
                ui.cardapioDatalist.innerHTML = '';
                window.appData.cardapio.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.nome;
                    ui.cardapioDatalist.appendChild(option);
                });
            }

            function renderCardapioItem(p, index) {
                 const isIfood = p.nome.includes('!');
                  if (p.isEditing) {
                        return `
                             <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                                 <div class="grid grid-cols-2 gap-4">
                                     <div class="col-span-2"><label class="text-sm font-medium">Nome</label><input type="text" data-field="nome" value="${p.nome}" class="w-full p-2 mt-1 border rounded-md"></div>
                                     <div><label class="text-sm font-medium">Custo (R$)</label><input type="number" data-field="custoProducao" value="${p.custoProducao}" class="w-full p-2 mt-1 border rounded-md"></div>
                                     <div><label class="text-sm font-medium">Venda (R$)</label><input type="number" data-field="precoVenda" value="${p.precoVenda}" class="w-full p-2 mt-1 border rounded-md"></div>
                                     <div class="col-span-2 flex items-center"><label class="flex items-center gap-2 text-sm font-medium"><input type="checkbox" data-field="eBebida" ${p.eBebida ? 'checked' : ''} class="h-4 w-4 rounded">É uma bebida?</label></div>
                                 </div>
                                 <div class="mt-4 flex gap-2 justify-end">
                                     <button class="cancel-edit-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md" data-index="${index}">Cancelar</button>
                                     <button class="save-edit-btn bg-green-500 text-white font-semibold py-2 px-4 rounded-md" data-index="${index}">Salvar</button>
                                 </div>
                             </div>
                        `;
                  } else {
                        return `
                             <div class="p-3 bg-white rounded-md border text-sm">
                                 <div class="flex justify-between items-start">
                                     <div>
                                         <p class="font-semibold text-base flex items-center gap-2">${p.nome.replace('!', '')} 
                                             ${isIfood ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full font-bold">iFood</span>' : '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">Anota Aí</span>'}
                                             ${p.eBebida ? '<span class="text-xs font-normal text-gray-500">(Bebida)</span>' : ''}
                                         </p>
                                         <p class="text-slate-500 text-xs mt-1">Custo: ${formatCurrency(p.custoProducao)} | Venda: ${formatCurrency(p.precoVenda)}</p>
                                     </div>
                                     <div class="flex gap-2">
                                         <button class="edit-cardapio-item-btn text-blue-500 hover:text-blue-700" data-index="${index}"><i data-lucide="edit" class="h-4 w-4"></i></button>
                                         <button class="remove-cardapio-item-btn text-red-500 hover:text-red-700" data-index="${index}"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                                     </div>
                                 </div>
                             </div>
                        `;
                  }
            }

            function renderCardapioList() {
                ui.cardapioListContainer.innerHTML = window.appData.cardapio.length === 0 
                    ? '<p class="italic text-slate-500 p-2">Nenhum produto cadastrado.</p>' 
                    : window.appData.cardapio.map(renderCardapioItem).join('');
                populateCardapioDatalist();
                lucide.createIcons();
            }

            function renderManualItemsList() {
                ui.fechamento.manualItem.listUl.innerHTML = sessionData.manualItems.length === 0
                    ? '<li class="italic list-none">Nenhum item manual.</li>'
                    : sessionData.manualItems.map((item, index) => `
                        <li class="flex justify-between items-center">
                            <span>${item.quantity}x ${item.name}</span>
                            <button class="remove-manual-item-btn text-red-500 hover:text-red-700" data-index="${index}">
                                <i data-lucide="x-circle" class="h-4 w-4"></i>
                            </button>
                        </li>`).join('');
                lucide.createIcons();
            }

            function renderExtraExpensesList() {
                 ui.fechamento.extraExpense.listUl.innerHTML = sessionData.extraExpenses.length === 0
                      ? '<li class="italic list-none">Nenhuma despesa extra.</li>'
                      : sessionData.extraExpenses.map((expense, index) => `
                         <li class="flex justify-between items-center">
                             <span>${expense.desc}: ${formatCurrency(expense.value)}</span>
                             <button class="remove-extra-expense-btn text-red-500 hover:text-red-700" data-index="${index}">
                                 <i data-lucide="x-circle" class="h-4 w-4"></i>
                             </button>
                         </li>`).join('');
                 lucide.createIcons();
            }
            
            function renderSummary(report) {
                 const { summary, details } = report;
                
                 ui.fechamento.summaryContainer.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-md text-lg">
                            <span class="font-medium text-blue-800">Total Entradas</span>
                            <span class="font-bold text-blue-900">${formatCurrency(details.totalEntradas)}</span>
                        </div>

                        <div class="flex justify-between items-center p-3 bg-red-50 rounded-md text-lg">
                            <span class="font-medium text-red-800">Total Despesas</span>
                            <span class="font-bold text-red-900">${formatCurrency(details.totalDespesas)}</span>
                        </div>

                        <div class="p-4 rounded-lg text-center transition-colors duration-300 mt-3 ${summary.lucroFinal >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            <p class="text-lg font-bold uppercase">(=) Resultado Final do Dia</p>
                            <p class="text-4xl font-extrabold mt-1">${formatCurrency(summary.lucroFinal)}</p>
                        </div>
                    </div>
                `;
            }

            function renderItensPendentes(nomes) {
                ui.fechamento.cadastroPendente.list.innerHTML = '';
                nomes.forEach(nome => {
                    const isIfood = nome.includes('!');
                    const platformLabel = isIfood 
                        ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full font-bold ml-2">iFood</span>' 
                        : '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold ml-2">Anota Aí</span>';
                    
                    const formId = `form-${nome.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const formHTML = `
                        <div id="${formId}" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                            <h4 class="font-bold text-slate-800 flex items-center">${nome.replace('!', '')} ${platformLabel}</h4>
                            <div class="grid grid-cols-2 gap-4 mt-2">
                                <div class="col-span-1"><label class="text-sm font-medium">Custo (R$)</label><input type="number" data-field="custo" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="col-span-1"><label class="text-sm font-medium">Preço (R$)</label><input type="number" data-field="preco" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="col-span-2"><label class="flex items-center gap-2 text-sm font-medium"><input type="checkbox" data-field="eBebida" class="h-4 w-4 rounded">É uma bebida?</label></div>
                            </div>
                            <div class="flex gap-2 mt-3">
                                <button class="ignorar-item-pendente-btn w-1/3 bg-gray-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-gray-600 text-sm" data-nome="${nome}">Ignorar</button>
                                <button class="salvar-item-pendente-btn w-2/3 bg-green-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-green-600 text-sm" data-nome="${nome}">Salvar Item</button>
                            </div>
                        </div>
                    `;
                    ui.fechamento.cadastroPendente.list.insertAdjacentHTML('beforeend', formHTML);
                });
                ui.fechamento.cadastroPendente.card.classList.remove('hidden');
            }

            function renderDetailedReport(reportData, container) {
                const { summary, details, channels, allSoldItems } = reportData;
                
                const createDetailRow = (label, calc, value, isNegative = true) => `
                    <div class="detail-row">
                        <div class="detail-label">
                            <span class="main-label ${isNegative ? 'text-red-700' : 'text-blue-800'}">${label}</span>
                            <span class="calc-label">${calc}</span>
                        </div>
                        <span class="detail-value ${isNegative ? 'text-red-800' : 'text-blue-900'}">${formatCurrency(value)}</span>
                    </div>`;

                let channelsHTML = '';
                for (const channelName in channels) {
                    const channel = channels[channelName];
                    let subChannelsHTML = '';
                    if(channel.subChannels) {
                        for(const subChannelName in channel.subChannels) {
                            const subChannel = channel.subChannels[subChannelName];
                            subChannelsHTML += `
                                <div class="ml-4 mt-2 p-3 bg-gray-50 rounded-md border">
                                    <h4 class="font-semibold text-slate-700">${subChannelName}</h4>
                                    <div class="text-sm space-y-1 mt-1">
                                        <div class="flex justify-between"><span>Faturamento:</span> <span class="font-medium">${formatCurrency(subChannel.faturamento)}</span></div>
                                        <div class="flex justify-between"><span>Pedidos:</span> <span class="font-medium">${subChannel.pedidos}</span></div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                    
                    let costsHTML = '';
                    if (channelName === 'iFood') {
                        costsHTML = `
                            <div class="flex justify-between text-sm" title="CMV proporcional ao faturamento do canal"><span class="text-red-600">(-) CMV do Canal:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.cmv)}</span></div>
                            <div class="flex justify-between text-sm" title="${formatCurrency(channel.faturamento)} x ${window.appData.config.taxaIfoodPercentual}%"><span class="text-red-600">(-) Taxa %:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.taxaPercentual)}</span></div>
                            <div class="flex justify-between text-sm" title="${channel.pedidos} pedidos x ${formatCurrency(window.appData.config.taxaIfoodFixa)}"><span class="text-red-600">(-) Taxa Fixa:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.taxaFixa)}</span></div>
                            <div class="flex justify-between text-sm" title="${channel.itemsEmbalagem} itens x ${formatCurrency(window.appData.config.custoAdicionalDelivery)}"><span class="text-red-600">(-) Custo Embalagens:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.custoEmbalagem)}</span></div>
                            <div class="flex justify-between text-sm" title="Somatório do frete nos pedidos do canal"><span class="text-red-600">(-) Custo Frete:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.custoFrete)}</span></div>
                        `;
                    } else if (channelName === 'Anota Aí') {
                        costsHTML = `
                            <div class="flex justify-between text-sm" title="CMV proporcional ao faturamento do canal"><span class="text-red-600">(-) CMV do Canal:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.cmv)}</span></div>
                            <div class="flex justify-between text-sm" title="${formatCurrency(details.canaisProprios.faturamentoCartao)} x ${window.appData.config.taxaCartao}%"><span class="text-red-600">(-) Taxa Cartão:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.taxaCartao)}</span></div>
                            <div class="flex justify-between text-sm" title="${channel.itemsEmbalagem} itens x ${formatCurrency(window.appData.config.custoAdicionalDelivery)}"><span class="text-red-600">(-) Custo Embalagens:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.custoEmbalagem)}</span></div>
                             <div class="flex justify-between text-sm" title="Somatório do frete nos pedidos do canal"><span class="text-red-600">(-) Custo Frete:</span> <span class="font-semibold text-red-600">${formatCurrency(channel.custoFrete)}</span></div>
                        `;
                    }
                    
                    const soldItemsHTML = channel.soldItems.length > 0 ? `
                        <details class="mt-3">
                            <summary class="cursor-pointer text-sm font-medium text-indigo-600 hover:text-indigo-800 flex items-center">
                                Ver Itens Vendidos
                                <i data-lucide="chevron-down" class="chevron-summary h-4 w-4 ml-1 transition-transform"></i>
                            </summary>
                            <div class="mt-2 text-xs space-y-1 max-h-40 overflow-y-auto pr-2">
                                <div class="grid grid-cols-4 font-bold text-slate-700 border-b pb-1">
                                    <div class="col-span-2">Item</div>
                                    <div class="text-center">Qtd</div>
                                    <div class="text-right">Receita</div>
                                </div>
                                ${channel.soldItems.map(item => `
                                    <div class="grid grid-cols-4 py-1 border-b border-slate-100">
                                        <div class="col-span-2">${item.name.replace('!', '')}</div>
                                        <div class="text-center">${item.quantity}</div>
                                        <div class="text-right">${formatCurrency(item.revenue)}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </details>
                    ` : '';

                    channelsHTML += `
                        <div class="card">
                            <h3 class="text-xl font-bold mb-2 text-indigo-700">${channelName}</h3>
                            <div class="space-y-1 text-md">
                                <div class="flex justify-between"><span>Faturamento Bruto:</span> <span class="font-semibold">${formatCurrency(channel.faturamento)}</span></div>
                                <div class="flex justify-between"><span>Total de Pedidos:</span> <span class="font-semibold">${channel.pedidos}</span></div>
                            </div>
                            <div class="mt-2 pt-2 border-t space-y-1">
                                ${costsHTML}
                            </div>
                            <div class="flex justify-between font-bold border-t pt-2 mt-2 text-lg">
                                <span>Lucro Livre do Canal:</span>
                                <span class="${channel.lucroLivre >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(channel.lucroLivre)}</span>
                            </div>
                            ${soldItemsHTML}
                            ${subChannelsHTML ? `<div class="mt-3 pt-3 border-t">${subChannelsHTML}</div>` : ''}
                        </div>
                    `;
                }


                container.innerHTML = `
                    <div class="card">
                        <h2 class="text-2xl font-bold mb-2 text-slate-900">Resumo Financeiro Geral</h2>
                        
                        <!-- RECEITAS -->
                        <div class="mb-4">
                           <div class="p-4 bg-blue-50 rounded-lg">
                                ${createDetailRow('(+) Faturamento Bruto', `${details.totalPedidos} pedidos geraram receita`, summary.faturamentoBruto, false)}
                                ${details.taxaServico > 0 ? createDetailRow('(+) Taxa de Serviço', 'Valor informado manualmente', details.taxaServico, false) : ''}
                           </div>
                        </div>

                        <!-- DESPESAS -->
                        <h3 class="text-xl font-bold mb-2 text-slate-800">Detalhamento das Despesas</h3>
                        <div class="p-4 bg-red-50/50 rounded-lg border border-red-100">
                             ${createDetailRow('(-) Custo dos Produtos (CMV)', `${details.totalItens} itens vendidos`, summary.cmv)}
                            
                             <div class="detail-row">
                                <div class="detail-label">
                                    <span class="main-label text-red-700">(-) Taxas de Canais e Pagamentos</span>
                                    <span class="calc-label">Detalhamento das taxas por plataforma</span>
                                </div>
                                <span class="detail-value text-red-800">${formatCurrency(summary.taxasTotais)}</span>
                            </div>
                            <div class="pl-6 space-y-2 pb-2">
                                ${createDetailRow(`&nbsp;&nbsp;&nbsp;Taxa iFood (${details.ifood.taxaPercentual}%)`, `sobre ${formatCurrency(details.ifood.faturamento)}`, details.ifood.valorPercentual)}
                                ${createDetailRow(`&nbsp;&nbsp;&nbsp;Taxa Fixa iFood`, `${details.ifood.pedidos} pedidos x ${formatCurrency(details.ifood.taxaFixa)}`, details.ifood.valorFixo)}
                                ${createDetailRow(`&nbsp;&nbsp;&nbsp;Taxa Cartão Próprio (${details.canaisProprios.taxaCartao}%)`, `sobre ${formatCurrency(details.canaisProprios.faturamentoCartao)}`, details.canaisProprios.valorTaxa)}
                            </div>
                            
                            ${createDetailRow('(-) Imposto Sobre Faturamento', `${details.imposto.percentual}% sobre ${formatCurrency(summary.faturamentoBruto)}`, details.imposto.valor)}
                            ${createDetailRow('(-) Custo Adicional Viagem', `${details.viagem.quantidade} itens x ${formatCurrency(details.viagem.custoUnitario)}`, summary.custoAdicionalViagem)}
                            ${createDetailRow('(-) Custo com Frete', `Somatório do frete dos relatórios`, details.custoFrete)}
                            ${createDetailRow('(-) Custo Fixo do Dia', `${formatCurrency(details.custoFixo.mensal)} / ${details.custoFixo.diasUteis} dias`, details.custoFixo.diario)}
                            ${createDetailRow('(-) Custo com Diaristas', `${details.custoDiaristas.quantidade} x ${formatCurrency(details.custoDiaristas.custoUnitario)}`, details.custoDiaristas.total)}
                            ${createDetailRow('(-) Despesas Extras', `${details.custoExtras.length} iten(s) lançado(s)`, summary.custoExtras)}
                        </div>

                        <!-- TOTAIS -->
                        <div class="mt-6 p-4 border-y-2 border-slate-200 space-y-2">
                            <div class="flex justify-between items-center text-lg font-bold">
                                <span class="text-blue-800">Total de Entradas</span>
                                <span class="text-blue-900">${formatCurrency(details.totalEntradas)}</span>
                            </div>
                            <div class="flex justify-between items-center text-lg font-bold">
                                <span class="text-red-800">Total de Despesas</span>
                                <span class="text-red-800">${formatCurrency(details.totalDespesas)}</span>
                            </div>
                        </div>

                        <!-- RESULTADO FINAL -->
                        <div class="p-4 rounded-lg text-center transition-colors duration-300 mt-6 ${summary.lucroFinal >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            <p class="text-lg font-bold uppercase">(=) Lucro Líquido do Dia</p>
                            <p class="text-4xl font-extrabold mt-1">${formatCurrency(summary.lucroFinal)}</p>
                        </div>
                    </div>
                    <div class="card">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900">Desempenho por Canal</h2>
                        <div id="channel-performance" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            ${channelsHTML}
                        </div>
                    </div>
                     <div class="card">
                        <h2 class="text-2xl font-bold mb-4 text-slate-900">Itens Vendidos (Consolidado)</h2>
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100">
                                <tr>
                                    <th class="p-2">Item</th>
                                    <th class="p-2 text-center">Quantidade</th>
                                    <th class="p-2 text-right">CMV Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${allSoldItems.map(item => `
                                    <tr class="border-b">
                                        <td class="p-2 font-medium">${item.name}</td>
                                        <td class="p-2 text-center">${item.quantity}</td>
                                        <td class="p-2 text-right">${formatCurrency(item.cmv)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                // Re-run lucide after rendering new icons
                lucide.createIcons();
            }

            function renderHistory() {
                const historyContainer = ui.historyContent;
                historyContainer.innerHTML = '';
                const sortedDates = Object.keys(window.appData.history).sort((a, b) => new Date(b) - new Date(a));

                if (sortedDates.length === 0) {
                    historyContainer.innerHTML = '<div class="text-center p-6 bg-white rounded-lg shadow"><p class="text-slate-600">Nenhum dia arquivado ainda.</p></div>';
                    return;
                }

                sortedDates.forEach(date => {
                    const report = window.appData.history[date];
                    const details = document.createElement('details');
                    details.className = 'card bg-white rounded-lg shadow-sm mb-4';
                    
                    const summary = document.createElement('summary');
                    summary.className = 'cursor-pointer p-4 flex justify-between items-center font-semibold text-lg';
                    summary.innerHTML = `
                        <span>${new Date(date + 'T00:00:00').toLocaleDateString('pt-BR', { year: 'numeric', month: 'long', day: 'numeric' })}</span>
                        <span class="${report.summary.lucroFinal >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(report.summary.lucroFinal)}</span>
                    `;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = 'p-4 border-t border-gray-200 space-y-8';
                    contentDiv.innerHTML = '<p class="text-slate-500 italic">Clique para expandir e ver os detalhes.</p>';

                    details.appendChild(summary);
                    details.appendChild(contentDiv);
                    historyContainer.appendChild(details);

                    details.addEventListener('toggle', () => {
                        if (details.open) {
                             renderDetailedReport(report, contentDiv);
                        }
                    });
                });
            }

            // --- LÓGICA DE DRAG & DROP ---
            function setupDropZone(dropZoneEl, inputEl, fileNameEl, fileSetter, buttonToShow) {
                const handler = (file) => {
                    fileSetter(file);
                    fileNameEl.textContent = file ? file.name : 'Nenhum arquivo.';
                    if(buttonToShow) buttonToShow.classList.toggle('hidden', !file);
                }
                dropZoneEl.addEventListener('click', () => inputEl.click());
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZoneEl.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZoneEl.addEventListener(eventName, () => dropZoneEl.classList.add('drag-over'));
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    dropZoneEl.addEventListener(eventName, () => dropZoneEl.classList.remove('drag-over'));
                });
                dropZoneEl.addEventListener('drop', e => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) handler(files[0]);
                });
                inputEl.addEventListener('change', e => {
                    if (e.target.files.length > 0) handler(e.target.files[0]);
                });
            }

            // --- LÓGICA DE NEGÓCIO E EVENTOS ---
            function resetDay() {
                sessionData = {
                    pedidoFile: null, itensFile: null, adicionaisFile: null, menuFile: null, manualItems: [], extraExpenses: [], ignoredItems: [], reviewedData: { pedidos: [], itens: [], adicionais: [] }, lastFullReport: null
                };
                
                ui.fechamento.pedidos.fileName.textContent = 'Nenhum arquivo.';
                ui.fechamento.pedidos.input.value = '';
                ui.fechamento.itens.fileName.textContent = 'Nenhum arquivo.';
                ui.fechamento.itens.input.value = '';
                ui.fechamento.adicionais.fileName.textContent = 'Nenhum arquivo.';
                ui.fechamento.adicionais.input.value = '';

                ui.fechamento.taxaServicoInput.value = '';
                ui.fechamento.staffCountInput.value = '';
                ui.fechamento.staffCostInput.value = '';
                ui.fechamento.extraExpense.desc.value = '';
                ui.fechamento.extraExpense.value.value = '';
                ui.fechamento.manualItem.nameInput.value = '';
                ui.fechamento.manualItem.quantityInput.value = '';
                
                renderManualItemsList();
                renderExtraExpensesList();
                ui.fechamento.summaryContainer.innerHTML = '<div class="text-center p-4 bg-gray-50 rounded-lg"><p class="text-slate-600">Aguardando dados...</p></div>';
                ui.detailedReportContent.innerHTML = '<div class="text-center p-6 bg-white rounded-lg shadow"><p class="text-slate-600">Calcule o resultado final na aba "Fechamento do Dia" para gerar o relatório.</p></div>';
                
                ui.fechamento.step1.classList.remove('disabled');
                ui.fechamento.step2.classList.add('disabled');
                ui.fechamento.cadastroPendente.card.classList.add('hidden');
                ui.fechamento.cadastroPendente.list.innerHTML = '';
                
                showNotification("Fechamento do dia reiniciado.", 'info');
            }

            function checkAndAdvance() {
                if (ui.fechamento.cadastroPendente.list.children.length === 0) {
                    ui.fechamento.cadastroPendente.card.classList.add('hidden');
                    ui.fechamento.step2.classList.remove('disabled');
                    showNotification('Todos os itens pendentes resolvidos! Prossiga.', 'success');
                }
            }
            
            /**
             * Parses CSV text, handling quoted fields, escaped quotes, and auto-detecting delimiters (comma or semicolon).
             * @param {string} csvText The raw CSV string.
             * @returns {string[][]} An array of arrays representing the rows and columns.
             */
            function parseCsvWithDelimiterDetection(csvText) {
                const lines = csvText.replace(/\r\n/g, '\n').trim().split('\n');
                if (lines.length === 0) return [];

                // Detect delimiter from the header row
                const header = lines[0];
                const delimiter = (header.match(/;/g) || []).length > (header.match(/,/g) || []).length ? ';' : ',';

                return lines.map(line => {
                    const columns = [];
                    let currentColumn = '';
                    let inQuotes = false;
                    for (let i = 0; i < line.length; i++) {
                        const char = line[i];
                        if (char === '"') {
                            if (inQuotes && line[i + 1] === '"') {
                                // This is an escaped quote (e.g., "" within a quoted field)
                                currentColumn += '"';
                                i++; // Skip the second quote of the pair
                            } else {
                                // This is a starting or ending quote
                                inQuotes = !inQuotes;
                            }
                        } else if (char === delimiter && !inQuotes) {
                            columns.push(currentColumn);
                            currentColumn = '';
                        } else {
                            currentColumn += char;
                        }
                    }
                    columns.push(currentColumn); // Add the last column
                    return columns;
                });
            }

            const parseFile = (file) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onerror = e => reject(e);

                if (file.name.endsWith('.xlsx')) {
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });
                            const firstSheetName = workbook.SheetNames[0];
                            const worksheet = workbook.Sheets[firstSheetName];
                            const csvString = XLSX.utils.sheet_to_csv(worksheet, { header: 1 });
                            resolve(csvString);
                        } catch (err) {
                            reject(err);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                } else { // Assume CSV ou outro formato de texto
                    reader.onload = e => resolve(e.target.result);
                    // Use default browser encoding (usually UTF-8), which works well with BOM
                    reader.readAsText(file); 
                }
            });
            
            function processarRelatorios() {
                try {
                    sessionData.ignoredItems = [];
                    const soldItems = getSoldItemsFromReviewedData();

                    if (Object.keys(soldItems).length === 0) {
                        return showNotification("Nenhum item vendido encontrado nos dados revisados.", 'warning');
                    }

                    const itensNaoEncontrados = new Set();
                    const cardapioNomesNormalizados = window.appData.cardapio.map(p => normalizeString(p.nome));

                    Object.values(soldItems).forEach(item => {
                        if (!cardapioNomesNormalizados.includes(normalizeString(item.name))) {
                            itensNaoEncontrados.add(item.name);
                        }
                    });
                    
                    if (itensNaoEncontrados.size > 0) {
                        renderItensPendentes(Array.from(itensNaoEncontrados));
                        showNotification(`${itensNaoEncontrados.size} item(ns) novo(s) encontrado(s).`, 'warning');
                    } else {
                        ui.fechamento.cadastroPendente.card.classList.add('hidden');
                        ui.fechamento.step2.classList.remove('disabled');
                        showNotification("Todos os itens verificados! Prossiga para os dados manuais.", 'success');
                    }
                } catch (err) {
                    showNotification("Erro ao processar itens vendidos.", 'error');
                    console.error(err);
                }
            }

            async function promptForTakeawayItems() {
                try {
                    const soldItems = getSoldItemsFromReviewedData();
                    
                    // Verifica se existe algum item do Anota Aí que *poderia* ser para viagem
                    const hasPotentialTakeaway = Object.values(soldItems).some(item => {
                        const itemCardapio = window.appData.cardapio.find(p => normalizeString(p.nome) === normalizeString(item.name));
                        return itemCardapio && !itemCardapio.eBebida && !item.name.includes('!');
                    });

                    if (hasPotentialTakeaway) {
                        // Limpa o campo e exibe o modal simplificado
                        const input = document.getElementById('total-takeaway-items-input');
                        if (input) input.value = '';
                        ui.takeawayModal.container.classList.remove('hidden');
                        if (input) input.focus();
                    } else {
                        // Se não houver itens do Anota Aí para viagem, o valor manual é 0
                        executeCalculation(0);
                    }

                } catch (err) {
                     showNotification("Erro ao processar itens para viagem.", 'error');
                     console.error(err);
                }
            }


            function getSoldItemsFromReviewedData() {
                 const soldItems = {};
                 const addOrUpdateItem = (name, quantity) => {
                     if (!name || isNaN(quantity)) return;
                     const normalizedName = normalizeString(name);
                     soldItems[normalizedName] = soldItems[normalizedName] || { name, quantity: 0 };
                     soldItems[normalizedName].quantity += quantity;
                 };

                 sessionData.reviewedData.itens.forEach(row => addOrUpdateItem(row[0], parseInt(row[1], 10)));
                 sessionData.reviewedData.adicionais.forEach(row => {
                     if(normalizeString(row[0]).includes('extra')) {
                         addOrUpdateItem(row[0], parseInt(row[1], 10));
                     }
                 });
                 sessionData.manualItems.forEach(item => addOrUpdateItem(item.name, item.quantity));

                 return soldItems;
            }


            async function executeCalculation(takeawayItemsAnotaAiManual) {
                try {
                    const { config } = window.appData;
                    
                    const soldItemsData = getSoldItemsFromReviewedData();
                    const allSoldItems = Object.values(soldItemsData);
                    
                    const allSoldItemsWithDetails = allSoldItems.map(item => {
                        const itemCardapio = window.appData.cardapio.find(p => normalizeString(p.nome) === normalizeString(item.name));
                        const cmv = (itemCardapio && !sessionData.ignoredItems.includes(normalizeString(item.name))) ? item.quantity * itemCardapio.custoProducao : 0;
                        const revenue = (itemCardapio && !sessionData.ignoredItems.includes(normalizeString(item.name))) ? item.quantity * itemCardapio.precoVenda : 0;
                        return {...item, cmv, revenue, eBebida: itemCardapio?.eBebida ?? false };
                    });
                    
                    const cmv = allSoldItemsWithDetails.reduce((sum, item) => sum + item.cmv, 0);

                    // Detalhamento por canal
                    const channels = {
                        'iFood': { faturamento: 0, pedidos: 0, soldItems: [], custoFrete: 0 },
                        'Anota Aí': { faturamento: 0, pedidos: 0, soldItems: [], custoFrete: 0, subChannels: {
                            'Consumo no local': { faturamento: 0, pedidos: 0 },
                            'Viagem/Retirada': { faturamento: 0, pedidos: 0 }
                        } },
                    };

                    allSoldItemsWithDetails.forEach(item => {
                        if (item.name.includes('!')) {
                            channels['iFood'].soldItems.push(item);
                        } else {
                            channels['Anota Aí'].soldItems.push(item);
                        }
                    });

                    let faturamentoBrutoRelatorio = 0, faturamentoIfood = 0, faturamentoCartaoProprio = 0, numPedidosIfood = 0;
                    
                    sessionData.reviewedData.pedidos.forEach(columns => {
                        if (columns.length < 12 || !columns[0] || isNaN(parseValue(columns[0]))) return; 
                        const status = (columns[11] || '').trim().toLowerCase();
                        if (status === 'cancelado') return; 
                        
                        const valorTotal = parseValue(columns[8]);
                        const valorFrete = parseValue(columns[6]); // COLUNA G = ÍNDICE 6
                        const retirada = (columns[4] || '').trim().toLowerCase();
                        const condicaoPagamento = (columns[2] || '').trim().toLowerCase();
                        const origem = (columns[1] || '').trim();

                        if (isNaN(valorTotal)) return;
                        faturamentoBrutoRelatorio += valorTotal;

                        let channel, subChannel;
                        if (origem.toLowerCase() === 'ifood') {
                            channel = channels['iFood'];
                            faturamentoIfood += valorTotal;
                            numPedidosIfood++;
                            channel.custoFrete += valorFrete;
                        } else {
                            channel = channels['Anota Aí'];
                            if (retirada === 'consumido no estabelecimento') subChannel = channel.subChannels['Consumo no local'];
                            else subChannel = channel.subChannels['Viagem/Retirada'];
                            channel.custoFrete += valorFrete;
                        }
                        
                        channel.faturamento += valorTotal;
                        channel.pedidos++;
                        if (subChannel) {
                            subChannel.faturamento += valorTotal;
                            subChannel.pedidos++;
                        }
                         if (condicaoPagamento.includes('cartão') && origem.toLowerCase() !== 'ifood') {
                            faturamentoCartaoProprio += valorTotal;
                        }
                    });
                                            
                    const faturamentoBruto = faturamentoBrutoRelatorio;
                    
                    // Calcular itens não-bebida do iFood automaticamente
                    const itemsIfoodNonBeverage = channels.iFood.soldItems.reduce((sum, item) => !item.eBebida ? sum + item.quantity : sum, 0);
                    
                    // Custo Embalagem
                    const custoEmbalagemIfood = itemsIfoodNonBeverage * parseValue(config.custoAdicionalDelivery);
                    const custoEmbalagemAnotaAi = takeawayItemsAnotaAiManual * parseValue(config.custoAdicionalDelivery);
                    const custoAdicionalViagem = custoEmbalagemIfood + custoEmbalagemAnotaAi;
                    
                    // CÁLCULOS DETALHADOS POR CANAL
                    channels['iFood'].cmv = channels.iFood.soldItems.reduce((sum, item) => sum + item.cmv, 0);
                    channels['iFood'].taxaPercentual = faturamentoIfood * (parseValue(config.taxaIfoodPercentual) / 100);
                    channels['iFood'].taxaFixa = numPedidosIfood * parseValue(config.taxaIfoodFixa);
                    channels['iFood'].custoEmbalagem = custoEmbalagemIfood;
                    channels['iFood'].itemsEmbalagem = itemsIfoodNonBeverage;
                    channels['iFood'].lucroLivre = channels['iFood'].faturamento - channels['iFood'].cmv - channels['iFood'].taxaPercentual - channels['iFood'].taxaFixa - channels['iFood'].custoEmbalagem - channels['iFood'].custoFrete;

                    channels['Anota Aí'].cmv = channels['Anota Aí'].soldItems.reduce((sum, item) => sum + item.cmv, 0);
                    channels['Anota Aí'].taxaCartao = faturamentoCartaoProprio * (parseValue(config.taxaCartao) / 100);
                    channels['Anota Aí'].custoEmbalagem = custoEmbalagemAnotaAi;
                    channels['Anota Aí'].itemsEmbalagem = takeawayItemsAnotaAiManual;
                    channels['Anota Aí'].lucroLivre = channels['Anota Aí'].faturamento - channels['Anota Aí'].cmv - channels['Anota Aí'].taxaCartao - channels['Anota Aí'].custoEmbalagem - channels['Anota Aí'].custoFrete;
                    
                    // CÁLCULOS GERAIS
                    const taxaServico = parseValue(ui.fechamento.taxaServicoInput.value);
                    const totalEntradas = faturamentoBruto + taxaServico;

                    const taxasTotais = channels['iFood'].taxaPercentual + channels['iFood'].taxaFixa + channels['Anota Aí'].taxaCartao;
                    const custoFreteTotal = channels['iFood'].custoFrete + channels['Anota Aí'].custoFrete;
                    const impostoFaturamentoValor = faturamentoBruto * (parseValue(config.impostoFaturamento) / 100);
                    const custoDiaristas = parseValue(ui.fechamento.staffCountInput.value) * parseValue(ui.fechamento.staffCostInput.value);
                    const custoExtras = sessionData.extraExpenses.reduce((sum, exp) => sum + exp.value, 0);
                    const custoFixoDia = parseValue(config.monthlyExpenses) / (parseInt(config.workingDays, 10) || 1);

                    const totalDespesas = cmv + taxasTotais + impostoFaturamentoValor + custoAdicionalViagem + custoFixoDia + custoDiaristas + custoFreteTotal + custoExtras;
                    const lucroFinal = totalEntradas - totalDespesas;
                    
                    const report = {
                        summary: {
                            faturamentoBruto, cmv, taxasTotais, lucroFinal, custoExtras, custoAdicionalViagem
                        },
                        details: {
                            totalPedidos: sessionData.reviewedData.pedidos.filter(p => p[11]?.toLowerCase() !== 'cancelado' && p[0]).length,
                            totalItens: allSoldItems.reduce((acc, item) => acc + item.quantity, 0),
                            taxaServico,
                            totalEntradas,
                            totalDespesas,
                            ifood: {
                                faturamento: faturamentoIfood,
                                pedidos: numPedidosIfood,
                                taxaPercentual: config.taxaIfoodPercentual,
                                taxaFixa: config.taxaIfoodFixa,
                                valorPercentual: channels['iFood'].taxaPercentual,
                                valorFixo: channels['iFood'].taxaFixa,
                            },
                            canaisProprios: {
                                faturamentoCartao: faturamentoCartaoProprio,
                                taxaCartao: config.taxaCartao,
                                valorTaxa: channels['Anota Aí'].taxaCartao,
                            },
                            imposto: {
                                percentual: config.impostoFaturamento,
                                valor: impostoFaturamentoValor,
                            },
                            viagem: {
                                quantidade: itemsIfoodNonBeverage + takeawayItemsAnotaAiManual,
                                custoUnitario: config.custoAdicionalDelivery,
                            },
                            custoFixo: {
                                mensal: config.monthlyExpenses,
                                diasUteis: config.workingDays,
                                diario: custoFixoDia,
                            },
                            custoDiaristas: {
                                quantidade: parseValue(ui.fechamento.staffCountInput.value),
                                custoUnitario: parseValue(ui.fechamento.staffCostInput.value),
                                total: custoDiaristas,
                            },
                            custoFrete: custoFreteTotal,
                            custoExtras: sessionData.extraExpenses,
                        },
                        channels,
                        allSoldItems: allSoldItemsWithDetails
                    };
                    
                    sessionData.lastFullReport = report;

                    renderSummary(report);
                    showNotification("Cálculo finalizado com sucesso!", 'success');

                } catch (err) {
                    showNotification("Ocorreu um erro ao calcular o resultado final.", 'error');
                    console.error("Erro no cálculo final:", err);
                }
            }


            // --- SETUP DOS EVENT LISTENERS ---
            ui.navLinks.forEach(link => link.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(link.dataset.page);
            }));

            ui.saveConfigBtn.addEventListener('click', () => {
                Object.keys(ui.configInputs).forEach(key => {
                    if(ui.configInputs[key]) {
                        window.appData.config[key] = ui.configInputs[key].value;
                    }
                });
                saveData();
                showNotification('Configurações salvas!', 'success');
            });
            
            ui.resetDayBtn.addEventListener('click', resetDay);

            ui.productForm.addBtn.addEventListener('click', () => {
                const newProduct = {
                    nome: ui.productForm.name.value.trim(),
                    custoProducao: parseValue(ui.productForm.cost.value),
                    precoVenda: parseValue(ui.productForm.price.value),
                    eBebida: ui.productForm.isBebida.checked,
                    isEditing: false
                };
                if (!newProduct.nome || !newProduct.custoProducao || !newProduct.precoVenda) {
                    return showNotification("Preencha Nome, Custo e Preço.", "error");
                }
                window.appData.cardapio.push(newProduct);
                window.appData.cardapio.sort((a,b) => a.nome.localeCompare(b.nome));
                saveData();
                renderCardapioList();
                Object.values(ui.productForm).forEach(el => {
                    if (el.type === 'checkbox') el.checked = false;
                    else if(el.tagName === 'INPUT') el.value = '';
                });
                showNotification("Produto adicionado com sucesso!", "success");
            });

            ui.cardapioListContainer.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                
                const index = parseInt(target.dataset.index, 10);
                
                if (target.matches('.remove-cardapio-item-btn')) {
                    // Substituindo confirm nativo por uma verificação simples por enquanto
                    // if (confirm(`Remover "${window.appData.cardapio[index].nome}" do cardápio?`)) {
                        window.appData.cardapio.splice(index, 1);
                        saveData();
                        renderCardapioList();
                        showNotification("Produto removido.", 'info');
                    // }
                } else if (target.matches('.edit-cardapio-item-btn')) {
                    window.appData.cardapio.forEach((p, i) => p.isEditing = i === index);
                    renderCardapioList();
                } else if (target.matches('.cancel-edit-btn')) {
                    window.appData.cardapio[index].isEditing = false;
                    renderCardapioList();
                } else if (target.matches('.save-edit-btn')) {
                    const itemContainer = target.closest('.p-4');
                    const editedProduct = {
                        nome: itemContainer.querySelector('[data-field="nome"]').value,
                        custoProducao: parseValue(itemContainer.querySelector('[data-field="custoProducao"]').value),
                        precoVenda: parseValue(itemContainer.querySelector('[data-field="precoVenda"]').value),
                        eBebida: itemContainer.querySelector('[data-field="eBebida"]').checked,
                        isEditing: false
                    };
                    window.appData.cardapio[index] = editedProduct;
                    window.appData.cardapio.sort((a,b) => a.nome.localeCompare(b.nome));
                    saveData();
                    renderCardapioList();
                    showNotification("Produto atualizado!", 'success');
                }
            });

            ui.exportCardapioCsvBtn.addEventListener('click', () => {
                if (window.appData.cardapio.length === 0) {
                    return showNotification("Nenhum produto no cardápio para exportar.", "warning");
                }
                
                const headers = ["Nome do Produto", "Custo de Produção", "Preço de Venda", "É Bebida"];
                const rows = window.appData.cardapio.map(p => [
                    `"${p.nome.replace(/"/g, '""')}"`, // Trata aspas no nome
                    p.custoProducao,
                    p.precoVenda,
                    p.eBebida ? 'SIM' : 'NAO'
                ]);

                let csvContent = headers.join(',') + '\r\n';
                rows.forEach(rowArray => {
                    let row = rowArray.join(',');
                    csvContent += row + '\r\n';
                });

                // BOM para garantir que o Excel entenda UTF-8
                const bom = new Uint8Array([0xEF, 0xBB, 0xBF]); 
                const blob = new Blob([bom, csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `cardapio_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showNotification("Exportação do cardápio iniciada.", "success");
            });

            ui.menuCsv.prepareBtn.addEventListener('click', () => {
                if (!sessionData.menuFile) return showNotification("Selecione um arquivo CSV ou XLSX.", "error");
                 parseFile(sessionData.menuFile).then(csvText => {
                    const data = parseCsvWithDelimiterDetection(csvText);
                    const rows = data.slice(1); // Pula o cabeçalho
                    ui.importModal.tableBody.innerHTML = '';
                    
                    rows.forEach(columns => {
                        if (columns.length < 1 || !columns[0]?.trim()) return; // Ignora linhas vazias

                        const tr = document.createElement('tr');
                        tr.className = 'border-b';
                        tr.innerHTML = `
                            <td class="p-2"><input type="text" value="${columns[0] || ''}" data-field="nome" class="w-full p-1 border rounded-md"></td>
                            <td class="p-2"><input type="number" value="${parseValue(columns[1])}" data-field="custoProducao" class="w-full p-1 border rounded-md"></td>
                            <td class="p-2"><input type="number" value="${parseValue(columns[2])}" data-field="precoVenda" class="w-full p-1 border rounded-md"></td>
                            <td class="p-2 text-center"><input type="checkbox" ${(columns[3]?.trim().toLowerCase() === 'true' || columns[3]?.trim().toLowerCase() === 'sim') ? 'checked' : ''} data-field="eBebida" class="h-4 w-4"></td>
                        `;
                        ui.importModal.tableBody.appendChild(tr);
                    });
                    ui.importModal.container.classList.remove('hidden');
                }).catch(err => {
                    console.error(err);
                    showNotification("Erro ao ler arquivo do cardápio.", "error")
                });
            });

            const closeModal = () => {
                ui.importModal.container.classList.add('hidden');
                ui.menuCsv.prepareBtn.classList.add('hidden');
                ui.menuCsv.fileName.textContent = '';
                sessionData.menuFile = null;
                ui.menuCsv.input.value = '';
            };
            ui.importModal.closeBtn.addEventListener('click', closeModal);
            ui.importModal.cancelBtn.addEventListener('click', closeModal);
            ui.takeawayModal.closeBtn.addEventListener('click', () => ui.takeawayModal.container.classList.add('hidden'));

            ui.takeawayModal.confirmBtn.addEventListener('click', () => {
                const input = document.getElementById('total-takeaway-items-input');
                const totalItems = parseValue(input.value);
                
                if (isNaN(totalItems) || totalItems < 0) {
                    showNotification("Por favor, insira um número válido.", "error");
                    return;
                }
                
                ui.takeawayModal.container.classList.add('hidden');
                executeCalculation(totalItems);
            });


            ui.importModal.saveBtn.addEventListener('click', () => {
                const newProducts = [];
                const reviewRows = ui.importModal.tableBody.querySelectorAll('tr');
                reviewRows.forEach(row => {
                    const product = {
                        nome: row.querySelector('[data-field="nome"]').value,
                        custoProducao: parseValue(row.querySelector('[data-field="custoProducao"]').value),
                        precoVenda: parseValue(row.querySelector('[data-field="precoVenda"]').value),
                        eBebida: row.querySelector('[data-field="eBebida"]').checked,
                        isEditing: false,
                    };
                    if (product.nome) newProducts.push(product);
                });
                window.appData.cardapio = newProducts.sort((a,b) => a.nome.localeCompare(b.nome));
                saveData();
                renderCardapioList();
                closeModal();
                showNotification("Cardápio importado com sucesso!", "success");
            });
            
            ui.fechamento.reviewFilesBtn.addEventListener('click', openReportReviewModal);
            
            ui.fechamento.finalizarBtn.addEventListener('click', promptForTakeawayItems);

            ui.fechamento.manualItem.addBtn.addEventListener('click', () => {
                const name = ui.fechamento.manualItem.nameInput.value.trim();
                const quantity = parseInt(ui.fechamento.manualItem.quantityInput.value, 10);

                if (!name || isNaN(quantity) || quantity <= 0) {
                    return showNotification("Informe um nome de item válido e uma quantidade.", "error");
                }

                const itemExists = window.appData.cardapio.some(p => normalizeString(p.nome) === normalizeString(name));
                if (!itemExists) {
                    return showNotification(`Item "${name}" não encontrado no cardápio. Cadastre-o primeiro.`, "error");
                }
                
                sessionData.manualItems.push({ name, quantity });
                renderManualItemsList();
                ui.fechamento.manualItem.nameInput.value = '';
                ui.fechamento.manualItem.quantityInput.value = '';
            });

            ui.fechamento.manualItem.listUl.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-manual-item-btn');
                if (removeBtn) {
                    const index = parseInt(removeBtn.dataset.index, 10);
                    sessionData.manualItems.splice(index, 1);
                    renderManualItemsList();
                }
            });

            ui.fechamento.cadastroPendente.list.addEventListener('click', (e) => {
                const saveBtn = e.target.closest('.salvar-item-pendente-btn');
                const ignoreBtn = e.target.closest('.ignorar-item-pendente-btn');
                
                if (ignoreBtn) {
                    const formContainer = ignoreBtn.closest('.bg-yellow-50');
                    const nome = ignoreBtn.dataset.nome;
                    sessionData.ignoredItems.push(normalizeString(nome));
                    formContainer.remove();
                    showNotification(`Item "${nome}" será ignorado.`, 'info');
                    checkAndAdvance();
                    return;
                }

                if (saveBtn) {
                    const formContainer = saveBtn.closest('.bg-yellow-50');
                    const nome = saveBtn.dataset.nome;
                    const newProduct = {
                        nome: nome,
                        custoProducao: parseValue(formContainer.querySelector('[data-field="custo"]').value),
                        precoVenda: parseValue(formContainer.querySelector('[data-field="preco"]').value),
                        eBebida: formContainer.querySelector('[data-field="eBebida"]').checked,
                        isEditing: false
                    };

                    if (!newProduct.custoProducao || !newProduct.precoVenda) {
                        return showNotification('Informe Custo e Preço de Venda.', 'error');
                    }

                    window.appData.cardapio.push(newProduct);
                    window.appData.cardapio.sort((a,b) => a.nome.localeCompare(b.nome));
                    saveData();
                    renderCardapioList();
                    formContainer.remove();
                    checkAndAdvance();
                }
            });
            
            ui.fechamento.extraExpense.addBtn.addEventListener('click', () => {
                const desc = ui.fechamento.extraExpense.desc.value.trim();
                const value = parseValue(ui.fechamento.extraExpense.value.value);
                if(!desc || value <= 0) return showNotification("Preencha a descrição e um valor válido.", "error");
                sessionData.extraExpenses.push({ desc, value });
                renderExtraExpensesList();
                ui.fechamento.extraExpense.desc.value = '';
                ui.fechamento.extraExpense.value.value = '';
            });

            ui.fechamento.extraExpense.listUl.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-extra-expense-btn');
                if (removeBtn) {
                    const index = parseInt(removeBtn.dataset.index, 10);
                    sessionData.extraExpenses.splice(index, 1);
                    renderExtraExpensesList();
                }
            });
            
            ui.archiveDayBtn.addEventListener('click', () => {
                if (sessionData.lastFullReport) {
                    const today = new Date().toISOString().split('T')[0];
                    window.appData.history[today] = sessionData.lastFullReport;
                    saveData();
                    showNotification(`Fechamento do dia ${today} arquivado com sucesso!`, 'success');
                    resetDay();
                } else {
                    showNotification("Nenhum relatório para arquivar. Calcule o resultado primeiro.", 'warning');
                }
            });

            ui.exportExcelBtn.addEventListener('click', () => {
                if (!sessionData.lastFullReport) {
                    return showNotification("Nenhum relatório para exportar.", "warning");
                }
                
                const { summary, channels, allSoldItems } = sessionData.lastFullReport;
                const wb = XLSX.utils.book_new();

                // Aba de Resumo
                const ws_summary_data = [
                    ["Resumo Financeiro Geral"],
                    ["Faturamento Bruto", summary.faturamentoBruto],
                    ["Custo dos Produtos (CMV)", summary.cmv],
                    ["Taxas Totais", summary.taxasTotais],
                    ["Imposto Sobre Faturamento", sessionData.lastFullReport.details.imposto.valor],
                    ["Custo Adicional Viagem", sessionData.lastFullReport.summary.custoAdicionalViagem],
                    ["Custo com Frete", sessionData.lastFullReport.details.custoFrete],
                    ["Custo Fixo do Dia", sessionData.lastFullReport.details.custoFixo.diario],
                    ["Custo com Diaristas", sessionData.lastFullReport.details.custoDiaristas.total],
                    ["Despesas Extras", summary.custoExtras],
                    [],
                    ["LUCRO LÍQUIDO", summary.lucroFinal]
                ];
                const ws_summary = XLSX.utils.aoa_to_sheet(ws_summary_data);
                XLSX.utils.book_append_sheet(wb, ws_summary, "Resumo");

                // Aba de Canais
                const ws_channels_data = [["Canal", "Faturamento", "Pedidos", "CMV", "Lucro Livre"]];
                for (const channelName in channels) {
                    const c = channels[channelName];
                    ws_channels_data.push([channelName, c.faturamento, c.pedidos, c.cmv, c.lucroLivre]);
                }
                const ws_channels = XLSX.utils.aoa_to_sheet(ws_channels_data);
                XLSX.utils.book_append_sheet(wb, ws_channels, "Canais");

                // Aba de Itens
                const ws_items_data = [["Item", "Quantidade", "CMV Total"]];
                allSoldItems.forEach(item => {
                    ws_items_data.push([item.name, item.quantity, item.cmv]);
                });
                const ws_items = XLSX.utils.aoa_to_sheet(ws_items_data);
                XLSX.utils.book_append_sheet(wb, ws_items, "Itens Vendidos");

                XLSX.writeFile(wb, `Relatorio_Fechamento_${new Date().toISOString().split('T')[0]}.xlsx`);

                showNotification("Exportação para Excel concluída.", "success");
            });

            // --- LÓGICA DO MODAL DE REVISÃO DE RELATÓRIOS
            async function openReportReviewModal() {
                const filesToReview = [
                    { name: 'Pedidos', file: sessionData.pedidoFile },
                    { name: 'Itens', file: sessionData.itensFile },
                    { name: 'Adicionais', file: sessionData.adicionaisFile }
                ];

                if (filesToReview.every(f => f.file === null)) {
                    return showNotification("Nenhum relatório importado para revisar.", "warning");
                }

                ui.reportReviewModal.tabs.innerHTML = '';
                ui.reportReviewModal.tabContent.innerHTML = '';

                let firstTab = true;
                for (const {name, file} of filesToReview) {
                    if (file) {
                        const tabId = `tab-${name.toLowerCase()}`;
                        const tabButton = document.createElement('button');
                        tabButton.className = 'tab-button';
                        if(firstTab) {
                            tabButton.classList.add('active');
                            firstTab = false;
                        }
                        tabButton.textContent = name;
                        tabButton.dataset.tab = tabId;
                        ui.reportReviewModal.tabs.appendChild(tabButton);

                        const tabContent = document.createElement('div');
                        tabContent.id = tabId;
                        tabContent.className = 'tab-content';
                        if(tabButton.classList.contains('active')) tabContent.classList.add('active');
                        
                        const csvText = await parseFile(file);
                        const rows = parseCsvWithDelimiterDetection(csvText);
                        
                        let tableHTML = `<div class="max-h-[50vh] overflow-auto"><table class="w-full text-xs text-left" id="table-${tabId}"><tbody>`;
                        rows.forEach((columns, rowIndex) => {
                            tableHTML += `<tr data-row-index="${rowIndex}">`;
                            columns.forEach((col, colIndex) => {
                                tableHTML += `<td><input type="text" value="${col.trim()}" class="w-full p-1 border rounded-md bg-white"></td>`;
                            });
                            tableHTML += `<td><button class="remove-row-btn text-red-500 p-1"><i data-lucide="trash-2" class="h-4 w-4"></i></button></td>`;
                            tableHTML += `</tr>`;
                        });
                        tableHTML += `</tbody></table></div>`;
                        tabContent.innerHTML = tableHTML;
                        ui.reportReviewModal.tabContent.appendChild(tabContent);
                    }
                }
                lucide.createIcons();
                ui.reportReviewModal.container.classList.remove('hidden');
            }

            ui.reportReviewModal.tabs.addEventListener('click', (e) => {
                const targetButton = e.target.closest('.tab-button');
                if(!targetButton) return;

                ui.reportReviewModal.tabs.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                targetButton.classList.add('active');

                ui.reportReviewModal.tabContent.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(targetButton.dataset.tab).classList.add('active');
            });

            ui.reportReviewModal.tabContent.addEventListener('click', (e) => {
                 const removeBtn = e.target.closest('.remove-row-btn');
                 if(removeBtn) {
                     removeBtn.closest('tr').remove();
                 }
            });

            ui.reportReviewModal.saveBtn.addEventListener('click', () => {
                ['pedidos', 'itens', 'adicionais'].forEach(type => {
                    const table = document.getElementById(`table-tab-${type}`);
                    sessionData.reviewedData[type] = []; // Limpa dados antigos
                    if(table) {
                        const rows = Array.from(table.querySelectorAll('tbody tr'));
                        const data = rows.map(row => {
                           const inputs = Array.from(row.querySelectorAll('input'));
                           return inputs.map(input => input.value);
                        });
                        sessionData.reviewedData[type] = data;
                    }
                });
                
                ui.reportReviewModal.container.classList.add('hidden');
                ui.fechamento.step1.classList.add('disabled');
                processarRelatorios();
            });

             const closeReportReviewModal = () => ui.reportReviewModal.container.classList.add('hidden');
             ui.reportReviewModal.closeBtn.addEventListener('click', closeReportReviewModal);
             ui.reportReviewModal.cancelBtn.addEventListener('click', closeReportReviewModal);


            // --- INICIALIZAÇÃO DA UI ---
            function initUI() {
                ui.currentDateDisplay.textContent = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const initialPage = window.location.hash.replace('#', '') || 'fechamento';
                
                updateUIFromData(); // Carrega os dados iniciais na UI
                showPage(`page-${initialPage}`);
                
                setupDropZone(ui.fechamento.pedidos.dropZone, ui.fechamento.pedidos.input, ui.fechamento.pedidos.fileName, file => { sessionData.pedidoFile = file; });
                setupDropZone(ui.fechamento.itens.dropZone, ui.fechamento.itens.input, ui.fechamento.itens.fileName, file => { sessionData.itensFile = file; });
                setupDropZone(ui.fechamento.adicionais.dropZone, ui.fechamento.adicionais.input, ui.fechamento.adicionais.fileName, file => { sessionData.adicionaisFile = file; });
                setupDropZone(ui.menuCsv.dropZone, ui.menuCsv.input, ui.menuCsv.fileName, file => { 
                    sessionData.menuFile = file;
                    ui.menuCsv.prepareBtn.classList.remove('hidden');
                });
                 // Listener para o evento 'toggle' em qualquer <details> no corpo do documento
                document.body.addEventListener('toggle', (event) => {
                    if (event.target.tagName === 'DETAILS') {
                        lucide.createIcons();
                    }
                }, true); // Use captura para garantir que o evento seja pego
            }
            
            initUI();
            
        }

    </script>
</body>
</html>
