<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Fechamento de Caixa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@0.379.0/dist/umd/lucide.min.js"></script>

    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        section.page { display: none; }
        section.page.active { display: block; }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
        }
        .btn-save-feedback { transition: all 0.3s ease; }
        .drop-zone {
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .drop-zone.drag-over {
            background-color: #e0e7ff;
            border-color: #6366f1;
        }
        details[open] summary .chevron {
            transform: rotate(180deg);
        }
        .step-container.disabled {
            opacity: 0.5;
            pointer-events: none;
        }
        .nav-link {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s, color 0.2s;
        }
        .nav-link.active {
            background-color: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <header class="bg-white/80 backdrop-blur-lg shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 md:px-8 flex justify-between items-center h-16">
            <div class="flex items-center space-x-2 sm:space-x-4">
                <a href="#fechamento" data-page="page-fechamento" class="nav-link text-slate-600 hover:text-indigo-600 font-semibold text-sm sm:text-base">Fechamento do Dia</a>
                <a href="#cardapio" data-page="page-cardapio" class="nav-link text-slate-600 hover:text-indigo-600 font-semibold text-sm sm:text-base">Cardápio</a>
            </div>
            <a href="https://wa.me/5567999093031" target="_blank" rel="noopener noreferrer" class="hidden sm:inline-flex items-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-all transform hover:scale-105">
                <i data-lucide="message-circle" class="h-5 w-5 mr-2"></i>
                Fale Comigo
            </a>
        </nav>
    </header>

    <main class="container mx-auto p-4 md:p-8 max-w-7xl">

        <!-- PÁGINA DE FECHAMENTO -->
        <section id="page-fechamento" class="page">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Fechamento do Dia (<span id="current-date-display"></span>)</h1>
                <p class="mt-2 text-md md:text-lg text-slate-600">Siga os passos para um fechamento de caixa rápido e preciso.</p>
            </header>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Coluna Principal: Ações do Dia -->
                <div class="lg:col-span-2 space-y-8">
                    <div class="card">
                        <h2 class="text-2xl font-bold mb-4 text-slate-800 flex items-center">
                            <i data-lucide="calculator" class="h-8 w-8 mr-3 text-indigo-600"></i>
                            Área de Fechamento Diário
                        </h2>
                        
                        <div id="step-1-container" class="step-container pt-4 border-t">
                            <h3 class="text-xl font-semibold text-slate-700 mb-3 flex items-center">
                                <span class="bg-indigo-600 text-white rounded-full h-8 w-8 text-lg font-bold flex items-center justify-center mr-3">1</span>
                                Importar Relatórios
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <p class="text-sm font-medium text-slate-600 mb-2">Relatório de Pedidos</p>
                                    <label for="relatorioPedidosInput" id="dropZonePedidos" class="drop-zone flex justify-center w-full px-4 py-5 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-400">
                                        <div class="text-center"><i data-lucide="file-up" class="mx-auto h-10 w-10 text-gray-400"></i><p class="mt-1 text-sm text-gray-600">Arraste ou clique</p></div>
                                    </label>
                                    <input type="file" id="relatorioPedidosInput" accept=".csv" class="hidden"/>
                                    <div id="fileNamePedidos" class="mt-2 text-xs text-center text-slate-500 font-medium">Nenhum arquivo.</div>
                                </div>
                                <div>
                                    <p class="text-sm font-medium text-slate-600 mb-2">Relatório de Itens Vendidos</p>
                                    <label for="relatorioItensInput" id="dropZoneItens" class="drop-zone flex justify-center w-full px-4 py-5 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-400">
                                        <div class="text-center"><i data-lucide="file-up" class="mx-auto h-10 w-10 text-gray-400"></i><p class="mt-1 text-sm text-gray-600">Arraste ou clique</p></div>
                                    </label>
                                    <input type="file" id="relatorioItensInput" accept=".csv" class="hidden"/>
                                    <div id="fileNameItens" class="mt-2 text-xs text-center text-slate-500 font-medium">Nenhum arquivo.</div>
                                </div>
                            </div>
                             <div class="mt-6 text-right">
                                <button id="processarRelatoriosBtn" class="bg-indigo-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-indigo-700 flex items-center justify-center ml-auto">
                                    Processar e Avançar <i data-lucide="arrow-right" class="h-5 w-5 ml-2"></i>
                                </button>
                            </div>
                        </div>

                        <div id="cadastro-pendente-card" class="card border-l-4 border-yellow-400 hidden mt-6">
                            <h2 class="text-2xl font-bold mb-2 text-yellow-600 flex items-center"><i data-lucide="alert-triangle" class="h-8 w-8 mr-3"></i> Ação Necessária: Itens Novos</h2>
                            <p class="text-slate-600 mb-4">Encontramos itens que não estão no cardápio. Cadastre-os para continuar.</p>
                            <div id="cadastro-pendente-list" class="mt-4 space-y-6"></div>
                        </div>

                         <div id="step-2-container" class="step-container disabled pt-6 border-t mt-6">
                            <h3 class="text-xl font-semibold text-slate-700 mb-3 flex items-center">
                                <span class="bg-indigo-600 text-white rounded-full h-8 w-8 text-lg font-bold flex items-center justify-center mr-3">2</span> Informar Dados Manuais
                            </h3>
                             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                 <div>
                                    <label for="itensParaViagemInput" class="block text-sm font-medium text-slate-700">Total de itens (não-bebidas) para viagem:</label>
                                    <input type="number" id="itensParaViagemInput" placeholder="0" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm p-2">
                                 </div>
                                 <div class="card bg-slate-50 p-4">
                                     <h4 class="text-md font-semibold text-slate-800 flex items-center mb-2"><i data-lucide="users" class="h-4 w-4 mr-2"></i>Custo com Diaristas</h4>
                                     <div class="grid grid-cols-2 gap-2">
                                         <div><label class="text-xs font-medium">Nº</label><input type="number" id="daily-staff-count" placeholder="0" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                         <div><label class="text-xs font-medium">Custo/Pessoa</label><input type="number" id="daily-staff-cost" placeholder="100" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                     </div>
                                 </div>
                             </div>
                             <div class="card bg-slate-50 p-4 mt-6">
                                 <h4 class="text-md font-semibold text-slate-800 flex items-center mb-2"><i data-lucide="plus-circle" class="h-4 w-4 mr-2"></i>Despesas Extras do Dia</h4>
                                 <div class="grid grid-cols-12 gap-2 items-end">
                                     <div class="col-span-7"><label class="text-xs font-medium">Descrição</label><input type="text" id="extra-expense-desc" placeholder="Ex: Gelo" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                     <div class="col-span-5"><label class="text-xs font-medium">Valor (R$)</label><input type="number" id="extra-expense-value" placeholder="20.00" class="w-full p-2 mt-1 border rounded-md text-sm"></div>
                                 </div>
                                <button id="add-extra-expense-btn" class="w-full mt-3 bg-blue-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-blue-600 text-sm">Adicionar Despesa</button>
                                 <div class="mt-3">
                                     <h5 class="font-medium text-slate-800 text-sm">Lançadas:</h5>
                                     <ul id="extra-expenses-list" class="mt-1 text-xs text-slate-600 list-disc list-inside max-h-20 overflow-y-auto p-2">
                                         <li class="italic list-none">Nenhuma despesa extra.</li>
                                     </ul>
                                 </div>
                             </div>
                              <div class="mt-6 text-right">
                                <button id="finalizarFechamentoBtn" class="bg-green-600 text-white font-bold text-lg py-3 px-8 rounded-lg hover:bg-green-700 transition shadow-lg flex items-center justify-center ml-auto">
                                    <i data-lucide="check-circle" class="h-6 w-6 mr-3"></i> Calcular Resultado Final
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-8">
                    <div class="card sticky top-20">
                        <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-slate-900 flex items-center"><i data-lucide="bar-chart-2" class="h-5 w-5 mr-3 text-indigo-600"></i>Resumo do Dia</h2>
                        <div id="summary-content" class="space-y-3">
                            <div class="text-center p-4 bg-gray-50 rounded-lg"><p class="text-slate-600">Aguardando dados...</p></div>
                        </div>
                    </div>
                    <div class="card">
                        <details>
                            <summary class="cursor-pointer text-xl font-semibold text-slate-900 flex items-center justify-between">
                                <span><i data-lucide="settings-2" class="h-5 w-5 mr-3 inline-block text-indigo-600"></i>Configurações</span>
                                <i data-lucide="chevron-down" class="chevron h-5 w-5 transition-transform"></i>
                            </summary>
                            <div class="mt-4 pt-4 border-t space-y-4">
                                <div><label class="block text-sm font-medium">Despesas Fixas Mensais (R$)</label><input type="number" id="config-monthly-expenses" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Dias Úteis no Mês</label><input type="number" id="config-working-days" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Taxa iFood (%)</label><input type="number" id="config-taxa-ifood-percentual" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Taxa Fixa iFood (R$)</label><input type="number" id="config-taxa-ifood-fixa" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Taxa Cartão (Canais Próprios, %)</label><input type="number" id="config-taxa-cartao" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div><label class="block text-sm font-medium">Custo Adicional por Item para Viagem (R$)</label><input type="number" id="config-custo-adicional-delivery" class="mt-1 block w-full p-2 border rounded-md"></div>
                                <div class="text-right mt-6"><button id="save-config-btn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-700 flex items-center justify-center ml-auto btn-save-feedback"><i data-lucide="save" class="h-5 w-5 mr-2"></i><span class="btn-text">Salvar</span></button></div>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
        </section>

        <!-- PÁGINA DO CARDÁPIO -->
        <section id="page-cardapio" class="page">
             <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Gerenciamento do Cardápio</h1>
                <p class="mt-2 text-md md:text-lg text-slate-600">Adicione, edite e organize todos os seus produtos e preços.</p>
            </header>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2 card">
                    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Produtos Carregados</h2>
                     <div id="cardapio-list-container" class="mt-2 text-sm text-slate-600 max-h-[70vh] overflow-y-auto p-2 space-y-2"></div>
                </div>
                <div class="space-y-8">
                    <div class="card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Adicionar Novo Produto</h2>
                         <div class="space-y-4">
                            <div><label class="text-sm font-medium">Nome do Produto <span class="text-xs text-gray-500">(use "!" no final para iFood)</span></label><input type="text" id="manual-product-name" class="w-full p-2 mt-1 border rounded-md"></div>
                            <div><label class="text-sm font-medium">Custo de Produção (R$)</label><input type="number" id="manual-product-cost" class="w-full p-2 mt-1 border rounded-md"></div>
                             <div><label class="text-sm font-medium">Preço de Venda (R$)</label><input type="number" id="manual-product-price" class="w-full p-2 mt-1 border rounded-md"></div>
                            <div class="pt-2"><label class="flex items-center gap-2 text-sm font-medium"><input type="checkbox" id="manual-product-is-bebida" class="h-4 w-4 rounded">É uma bebida?</label></div>
                        </div>
                        <button id="manual-add-product-btn" class="w-full mt-4 bg-green-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-600">Salvar Produto</button>
                    </div>
                     <div class="card">
                        <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Importar em Massa</h2>
                        <label for="daily-menu-csv-input" id="dropZoneCardapio" class="drop-zone mt-2 flex justify-center w-full px-6 py-5 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-indigo-400">
                            <div class="space-y-1 text-center"><i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-gray-400"></i><p class="mt-1 text-sm text-gray-600">Arraste ou clique</p></div>
                        </label>
                        <input type="file" id="daily-menu-csv-input" class="hidden" accept=".csv">
                        <div id="fileNameCardapio" class="mt-2 text-sm text-center text-slate-600 font-medium"></div>
                         <button id="prepare-import-btn" class="w-full mt-4 bg-indigo-500 text-white font-semibold py-2 px-4 rounded-md hover:bg-indigo-600 hidden">Revisar e Preparar Importação</button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal de Revisão de Importação -->
    <div id="import-review-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-4xl shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex justify-between items-center pb-3 border-b">
                    <h3 class="text-2xl font-bold text-slate-800">Revisão da Importação</h3>
                    <button id="close-modal-btn" class="cursor-pointer z-50 p-2 -mr-2">
                        <i data-lucide="x" class="h-6 w-6"></i>
                    </button>
                </div>
                <div class="mt-4">
                    <p class="text-sm text-slate-600 mb-4">Ajuste os valores detectados no arquivo CSV conforme necessário antes de salvar o novo cardápio. Linhas com nome em branco serão ignoradas.</p>
                    <div id="import-review-table-container" class="w-full max-h-[60vh] overflow-auto">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-100 sticky top-0">
                                <tr>
                                    <th class="p-2 w-3/6">Nome do Produto</th>
                                    <th class="p-2">Custo Prod.</th>
                                    <th class="p-2">Preço Venda</th>
                                    <th class="p-2 text-center">É Bebida?</th>
                                </tr>
                            </thead>
                            <tbody id="import-review-table-body">
                                <!-- Conteúdo gerado via JS -->
                            </tbody>
                        </table>
                    </div>
                    <div class="flex justify-end gap-4 mt-6 pt-4 border-t">
                        <button id="cancel-import-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md">Cancelar</button>
                        <button id="save-imported-cardapio-btn" class="w-auto bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">Salvar Cardápio Importado</button>
                     </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            
            // --- ELEMENTOS DA UI ---
            const pages = document.querySelectorAll('.page');
            const navLinks = document.querySelectorAll('.nav-link');
            const saveConfigBtn = document.getElementById('save-config-btn');
            const configInputs = {
                monthlyExpenses: document.getElementById('config-monthly-expenses'),
                workingDays: document.getElementById('config-working-days'),
                taxaIfoodPercentual: document.getElementById('config-taxa-ifood-percentual'),
                taxaIfoodFixa: document.getElementById('config-taxa-ifood-fixa'),
                taxaCartao: document.getElementById('config-taxa-cartao'),
                custoAdicionalDelivery: document.getElementById('config-custo-adicional-delivery'),
            };
            const productForm = {
                name: document.getElementById('manual-product-name'),
                cost: document.getElementById('manual-product-cost'),
                price: document.getElementById('manual-product-price'),
                isBebida: document.getElementById('manual-product-is-bebida'),
                addBtn: document.getElementById('manual-add-product-btn'),
            };
            const cardapioListContainer = document.getElementById('cardapio-list-container');
            const menuCsvInput = document.getElementById('daily-menu-csv-input');
            const prepareImportBtn = document.getElementById('prepare-import-btn');
            const importReviewModal = document.getElementById('import-review-modal');
            const importReviewTableBody = document.getElementById('import-review-table-body');
            const saveImportedCardapioBtn = document.getElementById('save-imported-cardapio-btn');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const cancelImportBtn = document.getElementById('cancel-import-btn');
            const step1Container = document.getElementById('step-1-container');
            const step2Container = document.getElementById('step-2-container');
            const relatorioPedidosInput = document.getElementById('relatorioPedidosInput');
            const relatorioItensInput = document.getElementById('relatorioItensInput');
            const processarRelatoriosBtn = document.getElementById('processarRelatoriosBtn');
            const finalizarFechamentoBtn = document.getElementById('finalizarFechamentoBtn');
            const staffCountInput = document.getElementById('daily-staff-count');
            const staffCostInput = document.getElementById('daily-staff-cost');
            const extraExpenseDescInput = document.getElementById('extra-expense-desc');
            const extraExpenseValueInput = document.getElementById('extra-expense-value');
            const addExtraExpenseBtn = document.getElementById('add-extra-expense-btn');
            const extraExpensesListUl = document.getElementById('extra-expenses-list');
            const summaryContainer = document.getElementById('summary-content');
            const cadastroPendenteCard = document.getElementById('cadastro-pendente-card');
            const cadastroPendenteList = document.getElementById('cadastro-pendente-list');
            
            document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            const todayKey = new Date().toISOString().split('T')[0];
            const STORAGE_KEY = 'hybridClosingData_v12';

            // --- ESTRUTURA DE DADOS E ESTADO ---
            const getDefaultData = () => ({
                config: {
                    monthlyExpenses: 2000, workingDays: 26, taxaIfoodPercentual: 15.2,
                    taxaIfoodFixa: 0.99, taxaCartao: 3.5, custoAdicionalDelivery: 2.00
                },
                cardapio: [],
                dailyLogs: {}, 
            });
            let data = getDefaultData();
            let pedidoFile = null;
            let itensFile = null;
            let menuFile = null;

            // --- FUNÇÕES UTILITÁRIAS ---
            const formatCurrency = (value) => !isNaN(value) ? value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : 'R$ 0,00';
            const parseValue = (value) => parseFloat(String(value).replace(',', '.')) || 0;
            
            // --- NAVEGAÇÃO ---
            function showPage(pageId) {
                pages.forEach(p => p.classList.remove('active'));
                document.getElementById(pageId)?.classList.add('active');
                navLinks.forEach(link => {
                    link.classList.toggle('active', link.dataset.page === pageId);
                });
                window.location.hash = pageId.replace('page-','');
            }

            navLinks.forEach(link => link.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(link.dataset.page);
            }));

            // --- LÓGICA DE DRAG & DROP ---
            function setupDropZone(dropZoneEl, inputEl, fileNameEl, fileSetter, buttonToShow) {
                const handler = (file) => {
                    fileSetter(file);
                    fileNameEl.textContent = file.name;
                    if(buttonToShow) buttonToShow.classList.remove('hidden');
                }
                dropZoneEl.addEventListener('click', () => inputEl.click());
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZoneEl.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
                });
                ['dragenter', 'dragover'].forEach(eventName => {
                    dropZoneEl.addEventListener(eventName, () => dropZoneEl.classList.add('drag-over'));
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    dropZoneEl.addEventListener(eventName, () => dropZoneEl.classList.remove('drag-over'));
                });
                dropZoneEl.addEventListener('drop', e => {
                    const files = e.dataTransfer.files;
                    if (files.length > 0) handler(files[0]);
                });
                inputEl.addEventListener('change', e => {
                    const files = e.target.files;
                     if (files.length > 0) handler(files[0]);
                });
            }

             // --- GERENCIAMENTO DE DADOS ---
            function saveData() {
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                } catch (e) { console.error("Erro ao salvar dados:", e); }
            }

            function loadData() {
                const savedData = localStorage.getItem(STORAGE_KEY);
                if (savedData) {
                    try {
                        const parsedData = JSON.parse(savedData);
                        // Merge com defaults para garantir que o objeto de dados não perca chaves
                        data.config = { ...getDefaultData().config, ...(parsedData.config || {}) };
                        data.cardapio = Array.isArray(parsedData.cardapio) ? parsedData.cardapio : [];
                        data.dailyLogs = typeof parsedData.dailyLogs === 'object' && parsedData.dailyLogs !== null ? parsedData.dailyLogs : {};
                    } catch (e) { 
                        console.error("Erro ao carregar dados, usando dados padrão.", e);
                        data = getDefaultData(); 
                    }
                } else {
                    data = getDefaultData();
                }

                if (!data.dailyLogs[todayKey]) {
                    data.dailyLogs[todayKey] = { extraExpenses: [], staff: { count: '', cost: '' } };
                }
                updateUIFromData();
            }

            // --- RENDERIZAÇÃO DA UI ---
            function updateUIFromData() {
                Object.keys(configInputs).forEach(key => {
                    configInputs[key].value = data.config[key] || '';
                });
                renderCardapioList();
                const todayLog = data.dailyLogs[todayKey];
                staffCountInput.value = todayLog.staff.count;
                staffCostInput.value = todayLog.staff.cost;
                renderExtraExpensesList();
                if(todayLog.summary){
                    renderSummary(todayLog.summary);
                }
            }
            
            function renderCardapioItem(p, index) {
                const isIfood = p.nome.includes('!');
                if (p.isEditing) {
                    return `
                        <div class="p-4 bg-indigo-50 rounded-lg border border-indigo-200">
                             <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2"><label class="text-sm font-medium">Nome</label><input type="text" data-field="nome" value="${p.nome}" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div><label class="text-sm font-medium">Custo Produção (R$)</label><input type="number" data-field="custoProducao" value="${p.custoProducao}" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div><label class="text-sm font-medium">Preço Venda (R$)</label><input type="number" data-field="precoVenda" value="${p.precoVenda}" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="col-span-2 flex items-center"><label class="flex items-center gap-2 text-sm font-medium"><input type="checkbox" data-field="eBebida" ${p.eBebida ? 'checked' : ''} class="h-4 w-4 rounded">É uma bebida?</label></div>
                             </div>
                             <div class="mt-4 flex gap-2 justify-end">
                                <button class="cancel-edit-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md" data-index="${index}">Cancelar</button>
                                <button class="save-edit-btn bg-green-500 text-white font-semibold py-2 px-4 rounded-md" data-index="${index}">Salvar</button>
                             </div>
                        </div>
                    `;
                } else {
                     return `
                        <div class="p-3 bg-white rounded-md border text-sm">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-base flex items-center gap-2">${p.nome.replace('!', '')} 
                                        ${isIfood ? '<span class="text-xs bg-red-100 text-red-800 px-2 py-0.5 rounded-full font-bold">iFood</span>' : '<span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">Anota Aí</span>'}
                                        ${p.eBebida ? '<span class="text-xs font-normal text-gray-500">(Bebida)</span>' : ''}
                                    </p>
                                    <p class="text-slate-500 text-xs mt-1">Custo: ${formatCurrency(p.custoProducao)} | Venda: ${formatCurrency(p.precoVenda)}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button class="edit-cardapio-item-btn text-blue-500 hover:text-blue-700" data-index="${index}"><i data-lucide="edit" class="h-4 w-4"></i></button>
                                    <button class="remove-cardapio-item-btn text-red-500 hover:text-red-700" data-index="${index}"><i data-lucide="trash-2" class="h-4 w-4"></i></button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }


            function renderCardapioList() {
                cardapioListContainer.innerHTML = '';
                if (data.cardapio.length === 0) {
                    cardapioListContainer.innerHTML = '<p class="italic text-slate-500 p-2">Nenhum produto cadastrado.</p>';
                    return;
                }
                data.cardapio.forEach((p, index) => {
                    const div = document.createElement('div');
                    div.innerHTML = renderCardapioItem(p, index);
                    cardapioListContainer.appendChild(div);
                });
                lucide.createIcons();
            }

             function renderExtraExpensesList() {
                extraExpensesListUl.innerHTML = '<li class="italic list-none">Nenhuma despesa extra.</li>';
                const todayExtraExpenses = data.dailyLogs[todayKey]?.extraExpenses;
                if(!todayExtraExpenses || todayExtraExpenses.length === 0) return;

                extraExpensesListUl.innerHTML = '';
                todayExtraExpenses.forEach((expense, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center';
                    li.innerHTML = `
                        <span>${expense.desc}: ${formatCurrency(expense.value)}</span>
                        <button class="remove-extra-expense-btn text-red-500 hover:text-red-700" data-index="${index}">
                            <i data-lucide="x-circle" class="h-4 w-4"></i>
                        </button>
                    `;
                    extraExpensesListUl.appendChild(li);
                });
                lucide.createIcons();
            }

            function renderSummary(summary) {
                summaryContainer.innerHTML = `
                    <div class="space-y-2">
                        <div class="flex justify-between items-center p-3 bg-blue-50 rounded-md text-lg">
                            <span class="font-medium text-blue-800">Faturamento Bruto</span>
                            <span class="font-bold text-blue-900">${formatCurrency(summary.faturamentoBruto)}</span>
                        </div>
                        <div class="text-sm space-y-1 pl-2">
                            <div class="flex justify-between items-center"><span class="text-orange-700">(-) Custo dos Produtos (CMV)</span><span class="font-medium">${formatCurrency(summary.cmv)}</span></div>
                            <div class="flex justify-between items-center"><span class="text-orange-700">(-) Taxas de Canais e Pag.</span><span class="font-medium">${formatCurrency(summary.taxasTotais)}</span></div>
                            <div class="flex justify-between items-center"><span class="text-orange-700">(-) Custo Adicional Viagem</span><span class="font-medium">${formatCurrency(summary.custoAdicionalViagem)}</span></div>
                            <div class="flex justify-between items-center"><span class="text-orange-700">(-) Custo Fixo do Dia</span><span class="font-medium">${formatCurrency(summary.custoFixoDia)}</span></div>
                            <div class="flex justify-between items-center"><span class="text-orange-700">(-) Custo com Diaristas</span><span class="font-medium">${formatCurrency(summary.custoDiaristas)}</span></div>
                            <div class="flex justify-between items-center"><span class="text-orange-700">(-) Despesas Extras</span><span class="font-medium">${formatCurrency(summary.custoExtras)}</span></div>
                        </div>
                        <div class="p-4 rounded-lg text-center transition-colors duration-300 mt-3 ${summary.lucroFinal >= 0 ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                            <p class="text-lg font-bold uppercase">(=) Resultado Final do Dia</p>
                            <p class="text-4xl font-extrabold mt-1">${formatCurrency(summary.lucroFinal)}</p>
                        </div>
                    </div>
                `;
            }
            
             function renderItensPendentes(nomes) {
                cadastroPendenteList.innerHTML = '';
                nomes.forEach(nome => {
                    const formId = `form-${nome.replace(/[^a-zA-Z0-9]/g, '-')}`;
                    const formHTML = `
                        <div id="${formId}" class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                             <h4 class="font-bold text-slate-800">${nome}</h4>
                             <div class="grid grid-cols-2 gap-4 mt-2">
                                <div class="col-span-1"><label class="text-sm font-medium">Custo Produção (R$)</label><input type="number" data-field="custo" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="col-span-1"><label class="text-sm font-medium">Preço Venda (R$)</label><input type="number" data-field="preco" class="w-full p-2 mt-1 border rounded-md"></div>
                                <div class="col-span-2"><label class="flex items-center gap-2 text-sm font-medium"><input type="checkbox" data-field="eBebida" class="h-4 w-4 rounded">É uma bebida?</label></div>
                             </div>
                             <button class="salvar-item-pendente-btn mt-3 w-full bg-green-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-green-600 text-sm" data-nome="${nome}">Salvar Item</button>
                        </div>
                    `;
                    cadastroPendenteList.insertAdjacentHTML('beforeend', formHTML);
                });
                cadastroPendenteCard.classList.remove('hidden');
                step1Container.classList.add('disabled');
            }

            // --- LÓGICA DE NEGÓCIO E EVENTOS ---

            saveConfigBtn.addEventListener('click', () => {
                Object.keys(configInputs).forEach(key => {
                    data.config[key] = configInputs[key].value;
                });
                saveData();
                const btnText = saveConfigBtn.querySelector('.btn-text');
                saveConfigBtn.classList.replace('bg-indigo-600', 'bg-green-500');
                btnText.textContent = 'Salvo!';
                setTimeout(() => {
                    saveConfigBtn.classList.replace('bg-green-500', 'bg-indigo-600');
                    btnText.textContent = 'Salvar';
                }, 2000);
            });
            
            productForm.addBtn.addEventListener('click', () => {
                const newProduct = {
                    nome: productForm.name.value.trim(),
                    custoProducao: parseValue(productForm.cost.value),
                    precoVenda: parseValue(productForm.price.value),
                    eBebida: productForm.isBebida.checked,
                    isEditing: false
                };
                if (!newProduct.nome || !newProduct.custoProducao) {
                    alert("Preencha pelo menos o Nome e o Custo de Produção."); return;
                }
                data.cardapio.push(newProduct);
                data.cardapio.sort((a,b) => a.nome.localeCompare(b.nome));
                saveData();
                renderCardapioList();
                productForm.name.value = '';
                productForm.cost.value = '';
                productForm.price.value = '';
                productForm.isBebida.checked = false;
            });

            cardapioListContainer.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                
                const index = parseInt(target.dataset.index, 10);
                
                if (target.matches('.remove-cardapio-item-btn')) {
                    if (confirm(`Remover "${data.cardapio[index].nome}" do cardápio?`)) {
                        data.cardapio.splice(index, 1);
                        saveData();
                        renderCardapioList();
                    }
                } else if (target.matches('.edit-cardapio-item-btn')) {
                    data.cardapio.forEach((p, i) => p.isEditing = i === index);
                    renderCardapioList();
                } else if (target.matches('.cancel-edit-btn')) {
                     data.cardapio[index].isEditing = false;
                     renderCardapioList();
                } else if (target.matches('.save-edit-btn')) {
                    const itemContainer = target.closest('.p-4');
                    const editedProduct = {
                        nome: itemContainer.querySelector('[data-field="nome"]').value,
                        custoProducao: parseValue(itemContainer.querySelector('[data-field="custoProducao"]').value),
                        precoVenda: parseValue(itemContainer.querySelector('[data-field="precoVenda"]').value),
                        eBebida: itemContainer.querySelector('[data-field="eBebida"]').checked,
                        isEditing: false
                    };
                    data.cardapio[index] = editedProduct;
                    data.cardapio.sort((a,b) => a.nome.localeCompare(b.nome));
                    saveData();
                    renderCardapioList();
                }
            });

            prepareImportBtn.addEventListener('click', () => {
                if (!menuFile) { alert("Por favor, selecione um arquivo CSV para importar."); return; }
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const csv = e.target.result;
                        const rows = csv.split('\n').slice(1);
                        importReviewTableBody.innerHTML = '';
                        rows.forEach((rowStr) => {
                            if (!rowStr.trim()) return;
                            const columns = rowStr.split(',');
                            const product = {
                                nome: columns[0]?.trim() || '',
                                custoProducao: parseValue(columns[1]),
                                precoVenda: parseValue(columns[2]),
                                eBebida: columns[3]?.trim().toLowerCase() === 'true',
                            };
                            const tr = document.createElement('tr');
                            tr.className = 'border-b';
                            tr.innerHTML = `
                                <td class="p-2"><input type="text" value="${product.nome}" data-field="nome" class="w-full p-1 border rounded-md"></td>
                                <td class="p-2"><input type="number" value="${product.custoProducao}" data-field="custoProducao" class="w-full p-1 border rounded-md"></td>
                                <td class="p-2"><input type="number" value="${product.precoVenda}" data-field="precoVenda" class="w-full p-1 border rounded-md"></td>
                                <td class="p-2 text-center"><input type="checkbox" ${product.eBebida ? 'checked' : ''} data-field="eBebida" class="h-4 w-4"></td>
                            `;
                            importReviewTableBody.appendChild(tr);
                        });
                        importReviewModal.classList.remove('hidden');
                    } catch(err) {
                        alert("Erro ao preparar a importação.");
                        console.error(err);
                    }
                };
                reader.readAsText(menuFile);
            });

            const closeModal = () => {
                importReviewModal.classList.add('hidden');
                prepareImportBtn.classList.add('hidden');
                document.getElementById('fileNameCardapio').textContent = '';
                menuFile = null;
            }

            closeModalBtn.addEventListener('click', closeModal);
            cancelImportBtn.addEventListener('click', closeModal);

            saveImportedCardapioBtn.addEventListener('click', () => {
                const newProducts = [];
                const reviewRows = importReviewTableBody.querySelectorAll('tr');
                reviewRows.forEach(row => {
                    const product = {
                        nome: row.querySelector('[data-field="nome"]').value,
                        custoProducao: parseValue(row.querySelector('[data-field="custoProducao"]').value),
                        precoVenda: parseValue(row.querySelector('[data-field="precoVenda"]').value),
                        eBebida: row.querySelector('[data-field="eBebida"]').checked,
                        isEditing: false,
                    };
                    if (product.nome) newProducts.push(product);
                });
                data.cardapio = newProducts;
                data.cardapio.sort((a,b) => a.nome.localeCompare(b.nome));
                saveData();
                renderCardapioList();
                closeModal();
                alert("Cardápio importado com sucesso!");
            });
            
            async function processarRelatorios() {
                if (!pedidoFile || !itensFile) {
                    alert("Por favor, importe o 'Relatório de Pedidos' e o 'Relatório de Itens Vendidos'.");
                    return;
                }
                const readFile = file => new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.onerror = e => reject(e);
                    reader.readAsText(file);
                });
                try {
                    const itensCSV = await readFile(itensFile);
                    const itensRows = itensCSV.split('\n').slice(1);
                    const itensNaoEncontrados = new Set();
                    itensRows.forEach(rowStr => {
                        if (!rowStr.trim()) return;
                        const columns = rowStr.split(',');
                        if (columns.length < 2) return;
                        const nomeItem = columns[0] ? columns[0].trim() : '';
                        if (!nomeItem) return;
                        const itemCardapio = data.cardapio.find(p => p.nome.toLowerCase() === nomeItem.toLowerCase());
                        if (!itemCardapio) {
                            itensNaoEncontrados.add(nomeItem);
                        }
                    });
                    if (itensNaoEncontrados.size > 0) {
                        renderItensPendentes(Array.from(itensNaoEncontrados));
                    } else {
                        step1Container.classList.add('disabled');
                        step2Container.classList.remove('disabled');
                        alert("Relatórios processados! Todos os itens foram encontrados. Prossiga para o Passo 2.");
                    }
                } catch (err) {
                    alert("Erro ao ler os arquivos.");
                    console.error(err);
                }
            }

            processarRelatoriosBtn.addEventListener('click', processarRelatorios);

            async function performFinalCalculation() {
                 if (!pedidoFile || !itensFile) {
                    alert("Os arquivos de relatório não foram carregados.");
                    return;
                }
                
                try {
                    const readFile = file => new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => resolve(e.target.result);
                        reader.onerror = e => reject(e);
                        reader.readAsText(file);
                    });

                    const [pedidosCSV, itensCSV] = await Promise.all([readFile(pedidoFile), readFile(itensFile)]);
                    
                    const pedidosRows = pedidosCSV.split('\n').slice(1);
                    let faturamentoBrutoDia = 0, faturamentoIfood = 0, faturamentoCartaoProprio = 0;
                    pedidosRows.forEach(rowStr => {
                        if (!rowStr.trim()) return;
                        const columns = rowStr.split(',');
                        if (columns.length < 8) return;
                        const valorTotal = parseValue(columns[4]);
                        const origem = columns[7] ? columns[7].trim() : '';
                        const condicaoPagamento = columns[6] ? columns[6].trim().toLowerCase() : '';
                        if (!isNaN(valorTotal)) {
                            faturamentoBrutoDia += valorTotal;
                            if (origem === 'iFood') faturamentoIfood += valorTotal;
                            if (origem !== 'iFood' && condicaoPagamento.includes('cartão')) faturamentoCartaoProprio += valorTotal;
                        }
                    });
                    const totalPedidosIfood = pedidosRows.filter(r => r.split(',')[7]?.trim() === 'iFood').length;
                    const { taxaIfoodPercentual, taxaIfoodFixa, taxaCartao } = data.config;
                    const taxasIfood = (faturamentoIfood * parseValue(taxaIfoodPercentual) / 100) + (totalPedidosIfood * parseValue(taxaIfoodFixa));
                    const taxasCartao = faturamentoCartaoProprio * parseValue(taxaCartao) / 100;
                    const taxasTotais = taxasIfood + taxasCartao;

                    const itensRows = itensCSV.split('\n').slice(1);
                    let cmvTotal = 0;
                    itensRows.forEach(rowStr => {
                        if (!rowStr.trim()) return;
                        const columns = rowStr.split(',');
                        if (columns.length < 2) return;
                        const nomeItem = columns[0] ? columns[0].trim() : '';
                        const quantidade = parseInt(columns[1], 10);
                        if (!nomeItem || isNaN(quantidade)) return;
                        const itemCardapio = data.cardapio.find(p => p.nome.toLowerCase() === nomeItem.toLowerCase());
                        if (itemCardapio) cmvTotal += quantidade * itemCardapio.custoProducao;
                    });
                    
                    const itensViagem = parseValue(document.getElementById('itensParaViagemInput').value);
                    const custoAdicionalTotal = itensViagem * parseValue(data.config.custoAdicionalDelivery);
                    const custoFixoDia = parseValue(data.config.monthlyExpenses) / (parseInt(data.config.workingDays, 10) || 1);
                    const custoDiaristas = parseValue(staffCountInput.value) * parseValue(staffCostInput.value);
                    const custoExtras = data.dailyLogs[todayKey].extraExpenses.reduce((sum, exp) => sum + exp.value, 0);
                    
                    const lucroFinal = faturamentoBrutoDia - cmvTotal - taxasTotais - custoAdicionalTotal - custoFixoDia - custoDiaristas - custoExtras;
                    const finalSummary = {
                        faturamentoBruto: faturamentoBrutoDia, cmv: cmvTotal, taxasTotais: taxasTotais,
                        custoAdicionalViagem: custoAdicionalTotal, custoFixoDia: custoFixoDia, custoDiaristas: custoDiaristas,
                        custoExtras: custoExtras, lucroFinal: lucroFinal,
                    };
                    
                    data.dailyLogs[todayKey].summary = finalSummary;
                    saveData();
                    renderSummary(finalSummary);

                } catch (err) {
                    alert("Ocorreu um erro ao calcular o resultado final.");
                    console.error("Erro no cálculo final:", err);
                }
            }
            
            finalizarFechamentoBtn.addEventListener('click', performFinalCalculation);

            document.body.addEventListener('change', (e) => {
                if (e.target.matches('.canal-chk')) {
                    const targetId = e.target.dataset.target;
                    const container = document.getElementById(targetId);
                    if (container) {
                        container.classList.toggle('hidden', !e.target.checked);
                    }
                }
            });

            cadastroPendenteList.addEventListener('click', (e) => {
                const saveBtn = e.target.closest('.salvar-item-pendente-btn');
                if (!saveBtn) return;
                
                const formContainer = saveBtn.parentElement;
                const nome = saveBtn.dataset.nome;
                const newProduct = {
                    nome: nome,
                    custoProducao: parseValue(formContainer.querySelector('[data-field="custo"]').value),
                    precoVenda: parseValue(formContainer.querySelector('[data-field="preco"]').value),
                    eBebida: formContainer.querySelector('[data-field="eBebida"]').checked,
                    isEditing: false
                };

                if (!newProduct.custoProducao || !newProduct.precoVenda) {
                    alert('Por favor, informe o Custo e o Preço de Venda para o item.');
                    return;
                }

                data.cardapio.push(newProduct);
                data.cardapio.sort((a,b) => a.nome.localeCompare(b.nome));
                saveData();
                renderCardapioList();
                formContainer.remove();

                if (cadastroPendenteList.children.length === 0) {
                    cadastroPendenteCard.classList.add('hidden');
                    step1Container.classList.add('disabled');
                    step2Container.classList.remove('disabled');
                    alert('Todos os itens pendentes foram cadastrados! Prossiga para o Passo 2.');
                }
            });

            [staffCountInput, staffCostInput].forEach(input => {
                input.addEventListener('change', () => {
                    data.dailyLogs[todayKey].staff.count = staffCountInput.value;
                    data.dailyLogs[todayKey].staff.cost = staffCostInput.value;
                    saveData();
                });
            });

            addExtraExpenseBtn.addEventListener('click', () => {
                const desc = extraExpenseDescInput.value.trim();
                const value = parseValue(extraExpenseValueInput.value);
                if(!desc || value <= 0) { alert("Preencha a descrição e um valor válido."); return; }
                data.dailyLogs[todayKey].extraExpenses.push({ desc, value });
                saveData(); renderExtraExpensesList();
                extraExpenseDescInput.value = extraExpenseValueInput.value = '';
            });

            extraExpensesListUl.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-extra-expense-btn');
                if (removeBtn) {
                    const index = parseInt(removeBtn.dataset.index, 10);
                    data.dailyLogs[todayKey].extraExpenses.splice(index, 1);
                    saveData(); renderExtraExpensesList();
                }
            });
            
            // --- INICIALIZAÇÃO ---
            const initialPage = window.location.hash.replace('#', '') || 'fechamento';
            showPage(`page-${initialPage}`);
            loadData();
            setupDropZone(document.getElementById('dropZonePedidos'), relatorioPedidosInput, document.getElementById('fileNamePedidos'), file => { pedidoFile = file; });
            setupDropZone(document.getElementById('dropZoneItens'), relatorioItensInput, document.getElementById('fileNameItens'), file => { itensFile = file; });
            setupDropZone(document.getElementById('dropZoneCardapio'), menuCsvInput, document.getElementById('fileNameCardapio'), file => { 
                menuFile = file;
                prepareImportBtn.classList.remove('hidden');
             });
        });
    </script>
</body>
</html>
